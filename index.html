<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pool Cost Estimator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --accent: #0797ee;
      --accent-light: #4fc3ff;
      --card-bg: #f9fafc;
      --card-border: #b3e6ff;
      --card-shadow: 0 2px 16px #0797ee11;
      --card-shadow-hover: 0 4px 24px #0797ee22;
      --orange: #e96c2c;
      --stepper-radius: 18px;
      --stepper-shadow: 0 6px 32px #0797ee22;
      --stepper-circle-size: 48px;
      --stepper-circle-size-mobile: 32px;
      --stepper-circle-border: 3px;
      --stepper-line: #b3e6ff;
      --stepper-label: #1786f9;
      --stepper-label-future: #b3e6ff;
      --stepper-label-completed: #fff;
      --stepper-label-active: #fff;
      --stepper-circle-completed: #4fc3ff;
      --stepper-circle-future: #e0f2ff;
      --stepper-circle-active: #fff;
      --stepper-circle-number: #0797ee;
      --stepper-circle-number-completed: #fff;
      --stepper-circle-number-future: #b3e6ff;
      --stepper-circle-shadow: 0 4px 24px #0797ee55;
      --stepper-accent: #0797ee;
      --stepper-accent-light: #4fc3ff;
      --stepper-bg-gradient: linear-gradient(90deg, #0797ee 0%, #4fc3ff 100%);
      --stepper-line-gradient: linear-gradient(90deg, #b3e6ff 0%, #4fc3ff 100%);
    }
    body {
      background: #fff;
      color: var(--text);
      font-family: Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      padding-bottom: 90px;
    }
    .stepper {
      display: flex;
      gap: 0;
      background: var(--stepper-bg);
      border-radius: 14px;
      padding: 0 0 0 0;
      margin: 0 auto 36px auto;
      max-width: 700px;
      overflow-x: auto;
      justify-content: center;
    }
    .stepper-circle {
      flex: 1 1 0;
      min-width: 70px;
      text-align: center;
      padding: 18px 0 10px 0;
      color: #7a8ba0;
      font-size: 15px;
      font-weight: 500;
      position: relative;
      background: none;
      border: none;
      outline: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      user-select: none;
    }
    .stepper-circle.active {
      color: var(--accent);
      font-weight: bold;
    }
    .stepper-circle span {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e8f1fb;
      color: inherit;
      font-size: 18px;
      margin-bottom: 6px;
    }
    .stepper-circle.active span {
      background: var(--accent);
      color: #fff;
    }
    .stepper-label {
      font-size: 13px;
      margin-top: 2px;
    }
    .main-title {
      font-size: 2.1em;
      font-weight: 700;
      text-align: center;
      margin: 0 0 10px 0;
      letter-spacing: 0.01em;
    }
    .subtitle {
      text-align: center;
      color: #4a5a6a;
      font-size: 1.1em;
      margin-bottom: 32px;
    }
    /* === DESIGN GRID: только CSS grid для всех карточек === */
    .design-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      max-width: 900px;
      margin: 0 auto;
      justify-items: center;
      justify-content: center;
      /* Используйте только grid для сетки карточек на всех шагах калькулятора! Flexbox запрещён. */
    }
    @media (max-width: 700px) {
      .design-grid {
        grid-template-columns: 1fr;
        gap: 10px;
        max-width: 98vw;
      }
    }
    /* Не используйте flexbox для .design-grid! Только grid. */
    .design-card {
      border: 2.5px solid var(--card-border);
      border-radius: 14px;
      background: var(--stepper-bg);
      box-shadow: var(--card-shadow);
      padding: 28px 18px 18px 18px;
      cursor: pointer;
      text-align: center;
      transition: box-shadow .22s, border-color .18s, background .18s;
      position: relative;
      outline: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 340px;
    }
    .design-card.selected {
      border-color: var(--accent);
      background: #e8f1fb;
      box-shadow: var(--card-shadow-hover);
    }
    .design-card:hover {
      border-color: var(--accent);
      box-shadow: var(--card-shadow-hover);
      background: #f2f8ff;
    }
    .design-card.whats-included {
      border-color: #4fc3ff;
      background: #f0f9ff;
      box-shadow: 0 2px 16px #4fc3ff22;
      cursor: default;
    }
    .design-card.whats-included:hover {
      border-color: #4fc3ff;
      background: #f0f9ff;
      box-shadow: 0 2px 16px #4fc3ff22;
    }
    .design-img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 14px 14px 0 0;
      margin-bottom: 16px;
      box-shadow: none;
      border: none;
      display: block;
      background: none;
      padding: 0;
    }
    .badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: var(--accent);
      color: #fff;
      font-size: 12px;
      padding: 3px 10px;
      border-radius: 7px;
      font-weight: 600;
      letter-spacing: 0.02em;
      box-shadow: 0 1px 4px #0001;
    }
    .card-title {
      font-size: 1.13em;
      font-weight: 600;
      margin-bottom: 5px;
    }
    .card-desc {
      color: #6a7a8a;
      font-size: 15px;
      margin-bottom: 12px;
      min-height: 36px;
    }
    .card-links {
      margin-top: auto;
    }
    .card-links a {
      color: var(--accent);
      text-decoration: underline;
      font-size: 15px;
      font-weight: 500;
    }
    .next-bar {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100vw;
      background: #fff;
      box-shadow: 0 -2px 16px #0001;
      padding: 18px 0 18px 0;
      display: flex;
      justify-content: flex-end;
      z-index: 100;
      border-top: 1.5px solid #e8f1fb;
    }
    .next-btn {
      padding: 15px 44px;
      border-radius: 11px;
      background: var(--orange);
      color: #fff;
      font-size: 19px;
      border: none;
      cursor: pointer;
      margin: 0 32px 0 0;
      font-weight: 600;
      transition: background .18s, box-shadow .18s;
      box-shadow: 0 2px 12px #e96c2c33;
      filter: brightness(1.05);
    }
    .next-btn:enabled:hover, .next-btn:enabled:focus {
      background: #ff7f3f;
      box-shadow: 0 4px 18px #e96c2c55;
      filter: brightness(1.13);
      outline: none;
    }
    .next-btn[disabled] {
      background: #fde2d2;
      color: #bbb;
      cursor: not-allowed;
      box-shadow: 0 1px 4px #0001;
      filter: none;
    }
    @media (max-width: 600px) {
      .main-title { font-size: 1.2em; }
      .subtitle { font-size: 1em; }
      .design-card { min-height: 260px; padding: 14px 4px 10px 4px; }
      .design-img { width: 100%; height: 120px; margin-bottom: 12px; }
      .next-btn { padding: 10px 12vw; font-size: 15px; margin-right: 10vw; }
      .next-bar { padding: 10px 0; }
    }
    /* === STEP 4: FINISHES (центрирование и единый стиль карточек, только grid) === */
    .finishes-container {
      max-width: 900px;
      margin: 0 auto;
      /* display: flex; flex-direction: column; align-items: center; gap: 0; */
    }
    .finish-group {
      margin-bottom: 36px;
      width: 100%;
    }
    .finish-title {
      font-weight: 600;
      font-size: 1.08em;
      margin-bottom: 14px;
      text-align: left;
    }
    /* Удалены finish-options-flex и finish-options-grid, используйте только .design-grid */
    .finishes-card {
      border: 2.5px solid var(--card-border);
      border-radius: 14px;
      background: var(--stepper-bg);
      box-shadow: var(--card-shadow);
      padding: 28px 18px 18px 18px;
      cursor: pointer;
      text-align: center;
      transition: box-shadow .22s, border-color .18s, background .18s;
      position: relative;
      outline: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 340px;
      width: 100%;
      max-width: 260px;
      box-sizing: border-box;
    }
    .design-card.selected, .finishes-card.selected {
      border-color: var(--accent);
      background: #e8f1fb;
      box-shadow: var(--card-shadow-hover);
    }
    .design-card:hover, .finishes-card:hover {
      border-color: var(--accent);
      box-shadow: var(--card-shadow-hover);
      background: #f2f8ff;
    }
    .finishes-img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 14px 14px 0 0;
      margin-bottom: 16px;
      box-shadow: none;
      border: none;
      display: block;
      background: none;
      padding: 0;
    }
    @media (max-width: 900px) {
      .finishes-card { min-height: 260px; padding: 14px 4px 10px 4px; }
      .finishes-img { height: 120px; margin-bottom: 12px; }
    }
    @media (max-width: 600px) {
      .finishes-card { min-height: 180px; }
      .finishes-img { height: 80px; }
    }
    /* === Единый стиль карточек для всех шагов === */
    .pool-size {
      font-size: 1.13em;
      font-weight: 600;
      color: #1786f9;
      margin: 6px 0 8px 0;
      text-align: center;
      letter-spacing: 0.01em;
      min-height: 1.2em;
    }
    @media (max-width: 600px) {
      .pool-size {
        font-size: 1em;
        margin: 4px 0 6px 0;
      }
    }
    /* === Конец: единый стиль карточек для всех шагов === */
    /* CSS для блока параметров Concrete */
    .concrete-params-block {
      margin: 18px 0 0 0;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .concrete-param-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 2px;
    }
    .concrete-label {
      min-width: 70px;
      font-weight: 600;
      color: #1786f9;
      font-size: 1.08em;
    }
    .concrete-num {
      width: 70px;
      font-size: 1.08em;
      padding: 3px 6px;
      border-radius: 6px;
      border: 1.5px solid #dbe3f0;
      text-align: right;
    }
    .concrete-slider {
      flex: 1 1 0;
      min-width: 80px;
      max-width: 220px;
    }
    @media (max-width: 600px) {
      .concrete-params-block { gap: 10px; }
      .concrete-param-row { flex-direction: column; align-items: flex-start; gap: 4px; }
      .concrete-label { font-size: 1em; }
      .concrete-num { width: 60px; font-size: 1em; }
      .concrete-slider { min-width: 60px; max-width: 100%; }
    }
    /* CSS для визуализации */
    .visual-preview-container {
      margin: 24px 0 18px 0;
      background: #f9fafc;
      border-radius: 18px;
      box-shadow: 0 2px 12px #0797ee11;
      padding: 18px 12px 18px 12px;
      max-width: 480px;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
    }
    .svg-label {
      font-size: 1.08em;
      color: #1786f9;
      font-weight: 600;
      margin: 8px 0 4px 0;
      text-align: left;
      font-family: Arial, sans-serif;
    }
    @media (max-width: 600px) {
      .visual-preview-container { padding: 8px 2px; max-width: 99vw; }
      .svg-label { font-size: 1em; }
    }
    /* === MODAL (Learn More) === */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(7,151,238,0.17); /* pooltools.au blue tint */
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.3s;
      opacity: 0;
      pointer-events: none;
    }
    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    .modal-learnmore {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 48px 0 rgba(7,151,238,0.13), 0 1.5px 8px 0 rgba(0,0,0,0.09);
      min-width: 320px;
      max-width: 92vw;
      min-height: 120px;
      max-height: 90vh;
      padding: 32px 28px 24px 28px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      animation: modalIn 0.28s cubic-bezier(.4,1.4,.6,1) both;
      font-family: inherit;
      overflow-y: auto;
    }
    @media (max-width: 600px) {
      .modal-learnmore {
        min-width: 0;
        width: 98vw;
        max-width: 99vw;
        padding: 18px 7vw 18px 7vw;
      }
    }
    @keyframes modalIn {
      0% { opacity: 0; transform: scale(0.92); }
      100% { opacity: 1; transform: scale(1); }
    }
    .modal-learnmore-title {
      font-size: 1.25em;
      font-weight: 700;
      color: #0797ee;
      margin-bottom: 10px;
      margin-top: 0;
      width: 100%;
    }
    .modal-learnmore-desc {
      font-size: 1.08em;
      color: #2a3a4a;
      margin-bottom: 22px;
      width: 100%;
      line-height: 1.5;
    }
    .modal-learnmore-close {
      position: absolute;
      top: 14px;
      right: 18px;
      background: none;
      border: none;
      font-size: 1.5em;
      color: #0797ee;
      cursor: pointer;
      z-index: 2;
      padding: 0 6px;
      border-radius: 6px;
      transition: background 0.15s;
    }
    .modal-learnmore-close:focus {
      outline: 2px solid #0797ee;
      background: #e8f1fb;
    }
    .modal-learnmore-btn {
      margin-top: auto;
      align-self: flex-end;
      background: #0797ee;
      color: #fff;
      border: none;
      border-radius: 9px;
      padding: 10px 28px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1.5px 8px 0 rgba(7,151,238,0.09);
      transition: background 0.18s;
    }
    .modal-learnmore-btn:focus {
      outline: 2px solid #0797ee;
      background: #1786f9;
    }
    /* === Learn More button on cards === */
    .learnmore-btn {
      display: block;
      width: 100%;
      margin: 14px 0 0 0;
      background: #e8f1fb;
      color: #0797ee;
      border: none;
      border-radius: 8px;
      padding: 8px 0;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.18s, color 0.18s;
      box-shadow: 0 1px 4px #0797ee11;
    }
    .learnmore-btn:hover, .learnmore-btn:focus {
      background: #0797ee;
      color: #fff;
      outline: none;
    }
    /* DRY: не дублируем стили, используем одни и те же классы для всех карточек */
    /* === END MODAL === */
    .card-content {
      flex: 1 1 auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    @media (max-width: 900px) {
      .card-content { min-height: 180px; }
    }
    .card-title {
      margin-bottom: 5px;
    }
    .card-desc {
      margin-bottom: 0;
    }
    .pool-size {
      margin-bottom: 0;
    }
    .learnmore-btn {
      margin-top: auto;
      margin-bottom: 0;
    }
    /* === MODERN STEPPER === */
    .modern-stepper-bar {
      width: 100%;
      max-width: 100%;
      background: var(--stepper-bg-gradient);
      border-radius: var(--stepper-radius);
      box-shadow: var(--stepper-shadow);
      padding: 18px 0 14px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 36px auto;
      min-width: 0;
      position: relative;
      z-index: 10;
      transition: background 0.3s;
      overflow: visible;
    }
    @media (max-width: 900px) {
      .modern-stepper-bar {
        align-items: center;
        padding: 10px 0 6px 0;
      }
      .modern-stepper-list {
        margin-top: -10px;
      }
    }
    @media (max-width: 600px) {
      .modern-stepper-bar {
        align-items: center;
        padding: 6px 0 4px 0;
      }
      .modern-stepper-list {
        margin-top: -8px;
      }
    }
    .modern-stepper-step.active .modern-stepper-circle {
      z-index: 20; /* glow всегда поверх */
    }
    .modern-stepper-list {
      display: flex;
      align-items: flex-end;
      width: 100%;
      min-width: 0;
      max-width: 100%;
      position: relative;
      justify-content: space-between;
      margin: -14px auto 0 auto; /* отрицательный внешний отступ для glow */
      overflow-x: auto;
      overflow-y: visible;
      white-space: nowrap;
      scrollbar-width: thin;
      scrollbar-color: #b3e6ff #e8f1fb;
    }
    @media (max-width: 900px) {
      .modern-stepper-bar {
        align-items: center;
        padding: 10px 0 6px 0;
      }
      .modern-stepper-list {
        margin-top: -10px;
      }
    }
    @media (max-width: 600px) {
      .modern-stepper-bar {
        align-items: center;
        padding: 6px 0 4px 0;
      }
      .modern-stepper-list {
        margin-top: -8px;
      }
    }
    /* Линия теперь отдельным элементом, не в каждом шаге! */
    .modern-stepper-connector {
      position: absolute;
      left: 0; right: 0;
      top: 50%;
      height: 3px;
      background: var(--stepper-line-gradient);
      z-index: 0;
      border-radius: 2px;
      opacity: 0.85;
      pointer-events: none;
      transform: translateY(-50%);
    }
    .modern-stepper-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-width: 0;
      flex: 1 1 0;
      z-index: 1;
      transition: filter 0.2s;
      overflow: visible; /* КРИТИЧНО: разрешаем glow выходить за пределы шага */
    }
    .modern-stepper-circle {
      width: var(--stepper-circle-size);
      height: var(--stepper-circle-size);
      border-radius: 50%;
      background: var(--stepper-circle-future);
      border: var(--stepper-circle-border) solid #b3e6ff;
      color: var(--stepper-circle-number-future);
      font-size: 1.13em;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 9px;
      box-shadow: 0 2px 8px #b3e6ff22, 0 1px 2px #fff8;
      transition: background .22s, border .22s, color .22s, box-shadow .22s, font-size .22s, filter .22s;
      outline: none;
      cursor: default;
      user-select: none;
      position: relative;
      z-index: 2;
      filter: blur(0.5px) saturate(1.1);
      backdrop-filter: blur(2.5px) saturate(1.2);
      background-clip: padding-box;
    }
    .modern-stepper-step.completed .modern-stepper-circle {
      background: var(--stepper-circle-completed);
      color: #fff;
      border-color: #4fc3ff;
      box-shadow: 0 0 0 4px #4fc3ff33, 0 2px 8px #0797ee33;
      filter: none;
      cursor: pointer;
    }
    .modern-stepper-step.active .modern-stepper-circle {
      background: var(--stepper-circle-active);
      color: #fff;
      border-color: var(--stepper-accent);
      font-size: 1.22em;
      box-shadow: 0 0 0 7px #4fc3ff55, 0 2px 16px #0797ee55;
      filter: drop-shadow(0 0 16px #4fc3ff88);
      cursor: pointer;
      animation: stepper-glow 1.2s infinite alternate;
    }
    @keyframes stepper-glow {
      0% { box-shadow: 0 0 0 7px #4fc3ff55, 0 2px 16px #0797ee55; }
      100% { box-shadow: 0 0 0 13px #4fc3ff44, 0 2px 24px #0797ee77; }
    }
    .modern-stepper-step.future .modern-stepper-circle {
      background: var(--stepper-circle-future);
      color: var(--stepper-circle-number-future);
      opacity: 0.95;
      border-color: #b3e6ff;
      filter: blur(0.5px) saturate(1.1);
      box-shadow: 0 2px 8px #b3e6ff22, 0 1px 2px #fff8;
      cursor: not-allowed;
    }
    .modern-stepper-label {
      font-size: 1.01em;
      font-family: inherit;
      color: var(--stepper-label);
      text-align: center;
      margin-top: 0;
      margin-bottom: 0;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 700;
      opacity: 0.97;
      white-space: nowrap;
      pointer-events: none;
      user-select: none;
      transition: color .22s, opacity .22s;
      text-shadow: 0 2px 8px #b3e6ff33;
    }
    .modern-stepper-step.completed .modern-stepper-label,
    .modern-stepper-step.active .modern-stepper-label {
      color: var(--stepper-label-active);
      opacity: 1;
      text-shadow: 0 2px 12px #4fc3ff77;
    }
    .modern-stepper-step.future .modern-stepper-label {
      color: var(--stepper-label-future);
      opacity: 0.7;
      text-shadow: none;
    }
    /* RESPONSIVENESS: на мобиле только степпер скроллится */
    @media (max-width: 900px) {
      .modern-stepper-bar {
        align-items: center;
        padding: 10px 0 6px 0;
      }
      .modern-stepper-list {
        /* min-width: 600px; */
        width: 100%;
        min-width: 0;
        max-width: 100vw;
        overflow-x: auto;
        white-space: nowrap;
        padding-left: 16px;
        padding-right: 16px;
        box-sizing: border-box;
      }
      .modern-stepper-circle {
        width: var(--stepper-circle-size-mobile);
        height: var(--stepper-circle-size-mobile);
        font-size: 0.95em;
      }
      .modern-stepper-label {
        font-size: 0.82em;
      }
      .modern-stepper-connector {
        height: 2px;
      }
    }
    @media (max-width: 600px) {
      .modern-stepper-bar {
        align-items: center;
        padding: 6px 0 4px 0;
      }
      .modern-stepper-list {
        /* min-width: 500px; */
        width: 100%;
        min-width: 0;
        max-width: 100vw;
        gap: 0;
        overflow-x: auto;
        white-space: nowrap;
        padding-left: 10px;
        padding-right: 10px;
        box-sizing: border-box;
      }
      .modern-stepper-label {
        display: none;
      }
      .modern-stepper-circle {
        width: 22px;
        height: 22px;
        font-size: 0.85em;
        margin-bottom: 0;
      }
      .modern-stepper-connector {
        height: 1.5px;
      }
    }
    /* === END MODERN STEPPER === */
    /* === СТИЛИ ДЛЯ НОВОГО КРЕАТИВНОГО STEPPER === */
    .stepper-container {
      width: 100%;
      max-width: 100vw;
      background: linear-gradient(90deg, #0797ee 0%, #4fc3ff 100%);
      border-radius: 20px;
      box-shadow: 0 6px 32px 0 #0797ee33, 0 1.5px 8px 0 #4fc3ff22;
      margin: 0 auto 38px auto;
      padding: 28px 2vw 24px 2vw; /* увеличен padding-top */
      overflow-x: auto;
      overflow-y: visible;
      overflow: visible;
      min-width: 0;
      box-sizing: border-box;
      position: relative;
    }
    .stepper-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 100vw;
      min-width: 0;
      position: relative;
      box-sizing: border-box;
      background: none;
      border-radius: 20px;
      box-shadow: none;
      padding: 0;
      margin: 0 auto;
      overflow-x: auto;
      overflow-y: visible;
      overflow: visible;
    }
    .stepper-bar::before {
      content: '';
      position: absolute;
      left: 8%;
      right: 8%;
      top: 50%;
      height: 4px;
      background: linear-gradient(90deg, #b3e6ff 0%, #0797ee 100%);
      border-radius: 2px;
      z-index: 0;
      opacity: 0.32;
      transform: translateY(-50%);
      pointer-events: none;
    }
    .stepper-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
      flex: 1 1 0;
      min-width: 70px;
      user-select: none;
      outline: none;
      background: none;
    }
    .stepper-circle {
      width: 44px;
      height: 44px;
      aspect-ratio: 1/1;
      border-radius: 50%;
      background: linear-gradient(145deg, #eaf6ff 60%, #b3e6ff 100%);
      color: #0797ee;
      font-weight: bold;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 12px #0797ee22, 0 1px 0 #fff;
      border: 3px solid #b3e6ff;
      transition: all 0.25s cubic-bezier(.45,.03,.48,.94);
      position: relative;
      overflow: visible;
      margin-bottom: 8px;
      filter: none;
      min-width: unset;
      min-height: unset;
      max-width: unset;
      max-height: unset;
      padding: 0;
    }
    @media (max-width: 900px) {
      .stepper-circle {
        width: 32px; height: 32px; aspect-ratio: 1/1; font-size: 13px;
      }
    }
    @media (max-width: 600px) {
      .stepper-circle {
        width: 18px; height: 18px; aspect-ratio: 1/1; font-size: 9px;
      }
    }
    .stepper-step.completed .stepper-circle {
      background: linear-gradient(145deg, #4fc3ff 60%, #0797ee 100%);
      border-color: #4fc3ff;
      color: #fff;
      box-shadow: 0 0 0 4px #4fc3ff33, 0 2px 12px #0797ee33;
    }
    .stepper-step.active .stepper-circle {
      border-color: #fff;
      background: linear-gradient(145deg, #0797ee 60%, #4fc3ff 100%);
      color: #fff;
      box-shadow: 0 0 0 10px #0797ee44, 0 2px 18px #0797ee77;
      animation: stepper-glow-creative 1.3s infinite alternate;
      z-index: 20;
    }
    @keyframes stepper-glow-creative {
      0% {
        box-shadow: 0 0 0 10px #0797ee44, 0 2px 18px #0797ee77;
        filter: brightness(1.08) drop-shadow(0 0 8px #4fc3ff88);
      }
      100% {
        box-shadow: 0 0 0 18px #4fc3ff33, 0 4px 28px #0797ee99;
        filter: brightness(1.13) drop-shadow(0 0 16px #4fc3ffcc);
      }
    }
    .stepper-step.future .stepper-circle {
      background: linear-gradient(145deg, #eaf6ff 60%, #b3e6ff 100%);
      color: #b3e6ff;
      border-color: #e0f2ff;
      opacity: 0.7;
      box-shadow: 0 1px 4px #b3e6ff22, 0 1px 2px #fff8;
      filter: blur(0.3px) saturate(1.1);
      cursor: not-allowed;
    }
    .stepper-label {
      margin-top: 4px;
      color: #fff;
      text-align: center;
      font-size: 13px;
      letter-spacing: 0.08em;
      font-weight: 700;
      text-shadow: 0 2px 10px #0797ee77, 0 1px 4px #4fc3ff55;
      white-space: nowrap;
      pointer-events: none;
      user-select: none;
      transition: color .22s, opacity .22s;
      opacity: 0.97;
    }
    .stepper-step.completed .stepper-label,
    .stepper-step.active .stepper-label {
      color: #fff;
      opacity: 1;
      text-shadow: 0 2px 14px #4fc3ffcc, 0 1px 6px #0797ee99;
    }
    .stepper-step.future .stepper-label {
      color: #b3e6ff;
      opacity: 0.6;
      text-shadow: none;
    }
    .stepper-step:focus .stepper-circle,
    .stepper-step:hover .stepper-circle {
      box-shadow: 0 0 0 12px #0797ee33, 0 2px 12px #0797ee55;
      outline: none;
      filter: brightness(1.10);
    }
    @media (max-width: 900px) {
      .stepper-bar { padding: 0; }
      .stepper-circle {
        width: 32px; height: 32px; min-width: 32px; min-height: 32px; max-width: 32px; max-height: 32px; font-size: 13px;
      }
      .stepper-step { min-width: 44px; }
    }
    @media (max-width: 600px) {
      .stepper-container { padding: 7px 1vw 10px 1vw; }
      .stepper-bar { padding: 0; }
      .stepper-circle {
        width: 18px; height: 18px; min-width: 18px; min-height: 18px; max-width: 18px; max-height: 18px; font-size: 9px;
      }
      .stepper-step { min-width: 24px; }
      .stepper-label { font-size: 8px; }
    }
    /* === КОНЕЦ: КРЕАТИВНЫЙ STEPPER === */
    /* Здесь могут быть дополнительные стили или скрипты. */
    @media (max-width: 900px) {
      .stepper-label { display: none; }
      .design-grid {
        grid-template-columns: 1fr !important;
        gap: 10px;
        max-width: 100vw;
        padding: 0;
      }
      .finishes-container {
        max-width: 100vw;
        padding: 0;
      }
      .design-card, .finishes-card {
        width: 100% !important;
        max-width: 100vw !important;
        min-width: 0 !important;
        margin: 0 !important;
        box-sizing: border-box;
      }
    }
    @media (max-width: 600px) {
      .stepper-label { display: none; }
      .design-grid {
        grid-template-columns: 1fr !important;
        gap: 8px;
        max-width: 100vw;
        padding: 0;
      }
      .finishes-container {
        max-width: 100vw;
        padding: 0;
      }
      .design-card, .finishes-card {
        width: 100% !important;
        max-width: 100vw !important;
        min-width: 0 !important;
        margin: 0 !important;
        box-sizing: border-box;
      }
    }
    /* Убираю max-width у .finishes-card для мобильных и планшетов */
    @media (max-width: 900px) {
      .finishes-card { max-width: none !important; }
    }
    @media (max-width: 600px) {
      .finishes-card { max-width: none !important; }
    }
    @media (max-width: 900px) {
      .design-grid, .finishes-container {
        grid-template-columns: 1fr !important;
        gap: 10px;
        max-width: 100vw;
        padding-left: 12px;
        padding-right: 12px;
        box-sizing: border-box;
      }
      .design-card, .finishes-card {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        margin: 0 !important;
        box-sizing: border-box;
        padding-left: 8px;
        padding-right: 8px;
      }
      .finishes-card {
        max-width: 100% !important;
      }
    }
    @media (max-width: 600px) {
      .design-grid, .finishes-container {
        grid-template-columns: 1fr !important;
        gap: 8px;
        max-width: 100vw;
        padding-left: 12px;
        padding-right: 12px;
        box-sizing: border-box;
      }
      .design-card, .finishes-card {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        margin: 0 !important;
        box-sizing: border-box;
        padding-left: 8px;
        padding-right: 8px;
      }
      .finishes-card {
        max-width: 100% !important;
      }
    }
    /* Убираю max-width у .finishes-card для мобильных и планшетов */
    @media (max-width: 900px) {
      .finishes-card { max-width: 100% !important; }
    }
    @media (max-width: 600px) {
      .finishes-card { max-width: 100% !important; }
    }
    @media (max-width: 900px) {
      .finishes-container .design-grid {
        grid-template-columns: 1fr !important;
        padding-left: 12px;
        padding-right: 12px;
        box-sizing: border-box;
      }
      .finishes-container .finishes-card,
      .finishes-container .design-grid .finishes-card,
      [class*='finishes-card'] {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        margin: 0 !important;
        box-sizing: border-box;
        padding-left: 8px;
        padding-right: 8px;
      }
    }
    @media (max-width: 600px) {
      .finishes-container .design-grid {
        grid-template-columns: 1fr !important;
        padding-left: 12px;
        padding-right: 12px;
        box-sizing: border-box;
      }
      .finishes-container .finishes-card,
      .finishes-container .design-grid .finishes-card,
      [class*='finishes-card'] {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        margin: 0 !important;
        box-sizing: border-box;
        padding-left: 8px;
        padding-right: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="stepper-container">
    <div class="stepper-bar" id="stepperBar"></div>
  </div>
  <h1 class="main-title">SELECT POOL MATERIAL</h1>
  <div class="subtitle">Choose the type of pool shell that best fits your needs. Only one option can be selected.</div>
  <div class="design-grid" id="designGrid"></div>
  <div id="concreteForm" style="display:none;"></div>
  <div class="next-bar">
    <button class="next-btn" id="prevBtn" style="background:#dde2d2;color:#222;margin-right:12px;display:none;">BACK</button>
    <button class="next-btn" id="nextBtn" disabled>NEXT</button>
  </div>
  <!-- === MODAL (Learn More) === -->
  <div id="modalOverlay" class="modal-overlay" tabindex="-1" aria-modal="true" style="display:none;">
    <div class="modal-learnmore" role="dialog" aria-labelledby="modalTitle" aria-describedby="modalDesc">
      <button class="modal-learnmore-close" id="modalCloseBtn" aria-label="Close">×</button>
      <h2 class="modal-learnmore-title" id="modalTitle">Learn More</h2>
      <div class="modal-learnmore-desc" id="modalDesc">Demo info about this option/card. (TODO: Inject real content here)</div>
      <button class="modal-learnmore-btn" id="modalCloseBtn2">Close</button>
    </div>
  </div>
  <!-- === END MODAL === -->
  <script>
    // --- ДАННЫЕ КАРТОЧЕК ---
    const materialOptions = [
      {
        id: "fibreglass",
        title: "Fibreglass",
        desc: "Prefabricated, fast installation, smooth finish. Wide range of shapes and sizes.",
        img: "images/fiberglass.jpg",
        badge: "Popular",
        link: { label: "Learn more", url: "#" },
        included: false
      },
      {
        id: "concrete",
        title: "Concrete",
        desc: "Custom shape and size, durable, suitable for any site. Fully tailored to your needs.",
        img: "images/concrete.jpg",
        badge: "Customizable",
        link: { label: "Learn more", url: "#" },
        included: false
      },
      {
        id: "vinyl",
        title: "Vinyl",
        desc: "Affordable, flexible design, soft surface. Quick installation and easy maintenance.",
        img: "images/placeholder.jfif",
        link: { label: "Learn more", url: "#" },
        included: false
      }
    ];
    // --- МОДЕЛИ ДЛЯ FIBREGLASS ---
    const fibreglassModels = [
      { id: "eden-center-steps", title: "Eden Center Steps", desc: "Blue Shell Pool", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/eden-center-steps-fibreglass-pool-shell" }, size: "6.2m x 3.2m x 1.6m" },
      { id: "halo-oval-spa", title: "Halo Oval Spa", desc: "Mini Shell Pool", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/halo-oval-spa-fibreglass-pool-shell" }, size: "4.0m x 2.5m x 1.3m" },
      { id: "the-stride", title: "The Stride", desc: "Lap Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/the-stride-fibreglass-pool-shell" }, size: "10.0m x 2.5m x 1.6m" },
      { id: "luma", title: "Luma", desc: "Shell Swimming Pool", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/luma-fibreglass-pool-shell" }, size: "7.0m x 3.5m x 1.7m" },
      { id: "avoca", title: "Avoca", desc: "Plunge Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/avoca-fibreglass-pool-shell" }, size: "6.0m x 3.2m x 1.6m" },
      { id: "olympia", title: "Olympia", desc: "Fibreglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/olympia-fibreglass-pool-shell" }, size: "8.0m x 4.0m x 1.8m" },
      { id: "horizon", title: "Horizon", desc: "Fibreglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/horizon-fibreglass-pool-shell" }, size: "7.5m x 3.5m x 1.7m" },
      { id: "marra-coora", title: "Marra Coora", desc: "Fibreglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/marra-coora-fibreglass-pool-shell" }, size: "6.5m x 3.2m x 1.6m" },
      { id: "azure", title: "Azure", desc: "Pool Fibreglass Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/azure-fibreglass-pool-shell" }, size: "5.5m x 2.5m x 1.5m" },
      { id: "moana", title: "Moana", desc: "Fibreglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/moana-fibreglass-pool-shell" }, size: "6.0m x 3.0m x 1.6m" },
      { id: "yara-with-spa", title: "Yara with SPA", desc: "Spa Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/yara-with-spa-fibreglass-pool-shell" }, size: "7.5m x 3.5m x 1.7m" },
      { id: "billabong", title: "Billabong", desc: "Fibreglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/billabong-fibreglass-pool-shell" }, size: "5.0m x 2.5m x 1.5m" },
      { id: "mirra", title: "Mirra", desc: "Fibreglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/mirra-fibreglass-pool-shell" }, size: "4.5m x 2.5m x 1.4m" },
      { id: "drift", title: "Drift", desc: "Fibreglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/drift-fibreglass-pool-shell" }, size: "6.0m x 2.5m x 1.5m" },
      { id: "ariki", title: "Ariki", desc: "Big Shell Pool", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/ariki-fibreglass-pool-shell" }, size: "8.5m x 4.0m x 1.8m" },
      { id: "aloha", title: "Aloha", desc: "Fibreglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/aloha-fibreglass-pool-shell" }, size: "7.0m x 3.5m x 1.7m" },
      { id: "aria", title: "Aria", desc: "Fibreglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/aria-fibreglass-pool-shell" }, size: "6.0m x 3.0m x 1.6m" },
      { id: "eden-end-steps", title: "Eden End Steps", desc: "Fibreglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/eden-end-steps-fibreglass-pool-shell" }, size: "6.2m x 3.2m x 1.6m" },
      { id: "solenne", title: "Solenne", desc: "Fibreglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/solenne-fibreglass-pool-shell" }, size: "7.5m x 3.5m x 1.7m" },
      { id: "triton", title: "Triton", desc: "Fiberglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/triton-fibreglass-pool-shell" }, size: "10.0m x 2.5m x 1.6m" },
      { id: "alto", title: "Alto", desc: "Fibreglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/alto-fibreglass-pool-shell" }, size: "5.5m x 2.5m x 1.5m" },
      { id: "vela-spa", title: "Vela Spa", desc: "Plunge Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/vela-spa-fibreglass-pool-shell" }, size: "6.0m x 2.5m x 1.4m" },
      { id: "the-rocks", title: "The Rocks", desc: "Plunge Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/the-rocks-fibreglass-pool-shell" }, size: "4.0m x 2.5m x 1.3m" },
      { id: "eden-with-spa", title: "7.5m Eden with Spa", desc: "Plunge Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/eden-with-spa-fibreglass-pool-shell" }, size: "7.5m x 3.5m x 1.7m" },
      { id: "longbeach", title: "Longbeach", desc: "Large Shell Pool", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/longbeach-fibreglass-pool-shell" }, size: "6.0m x 2.5m x 1.5m" },
      { id: "yara", title: "Yara", desc: "Fibreglass Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/yara-fibreglass-pool-shell" }, size: "6.2m x 3.2m x 1.6m" },
      { id: "arctic-white", title: "Arctic White", desc: "Plunge Pool Shell", img: "images/fiberglass.jpg", link: { label: "Learn more", url: "https://pooltools.au/products/arctic-white-fibreglass-pool-shell" }, size: "4.0m x 2.0m x 1.2m" }
    ];
    // --- ФОРМЫ ДЛЯ CONCRETE ---
    const concreteShapes = [
      { id: "rectangle", title: "Rectangle", img: "images/concrete.jpg", desc: "Classic rectangular shape." },
      { id: "oval", title: "Oval", img: "images/concrete.jpg", desc: "Smooth oval shape." },
      { id: "square", title: "Square", img: "images/concrete.jpg", desc: "Modern square shape." }
    ];
    // --- ДАННЫЕ ДЛЯ EQUIPMENT ---
    const equipmentOptions = [
      { id: "basic", title: "Basic", desc: "Single Speed Pump, Chlorinator, Filter", img: "images/placeholder.jfif", badge: "Included", included: true, price: 0 },
      { id: "intermediate", title: "Intermediate", desc: "Variable Speed Pump, Halo Chlor 25, Med Spec Filter, 2 Lights", img: "images/placeholder.jfif", included: false, price: 12000 },
      { id: "family", title: "Family Size", desc: "Variable Speed Pump, Quad Core Filter, Halo 35 Chlor, 2 Lights", img: "images/placeholder.jfif", included: false, price: 15000 }
    ];
    // --- ДАННЫЕ ДЛЯ FINISHES ---
    const finishesCoping = [
      { id: "concrete_pool_edge", title: "Concrete Pool Edge System", desc: "Standard edge system.", badge: "Included", included: true, img: "images/placeholder.jfif", price: 0 },
      { id: "natural_stone", title: "Drop Down Face Paver - Natural Stone", desc: "Premium natural stone.", included: false, img: "images/placeholder.jfif", price: 8500, included: false },
      { id: "porcelain", title: "Drop Down Face Paver - Porcelain", desc: "Modern porcelain finish.", included: false, img: "images/placeholder.jfif", price: 7000, included: false },
      { id: "ceramic", title: "Drop Down Face Paver - Ceramic", desc: "Classic ceramic finish.", included: false, img: "images/placeholder.jfif", price: 6000, included: false }
    ];
    const finishesInternal = [
      { id: "glass_mosaic", title: "Glass Mosaic", desc: "Premium glass mosaic.", badge: "Included", included: true, img: "images/placeholder.jfif", price: 0 },
      { id: "porcelain_40", title: "40x40 Porcelain", desc: "Porcelain tile 40x40mm.", included: false, img: "images/placeholder.jfif", price: 5000, included: false },
      { id: "penny_rounds", title: "Penny Rounds", desc: "Stylish penny rounds.", included: false, img: "images/placeholder.jfif", price: 4000, included: false }
    ];
    // --- ДАННЫЕ СТЕППЕРА ---
    const steps = [
      { label: "Material" },
      { label: "Design" },
      { label: "Equipment" },
      { label: "Finishes" },
      { label: "Hardscape" },
      { label: "Cover" },
      { label: "Amenities" },
      { label: "Included" },
      { label: "Planning" },
      { label: "Cost" }
    ];
    // --- СОСТОЯНИЕ ---
    let stepIndex = 0;
    let selectedMaterial = null;
    let selectedDesign = null;
    let selectedShape = null;
    concreteDims = { length: 8, width: 4, depth: 1.5 };
    let selectedEquipment = null;
    let selectedCoping = null;
    let selectedInternal = null;
    // --- ДАННЫЕ ДЛЯ HARDSCAPE ---
    let selectedHardscape = null;
    // --- ДАННЫЕ ДЛЯ COVER ---
    let selectedCover = null;
    // --- ДАННЫЕ ДЛЯ AMENITIES ---
    let selectedAmenities = [];
    // --- ДАННЫЕ ДЛЯ WHAT'S INCLUDED ---
    const includedOptions = [
      { id: "excavation", title: "Excavation", desc: "Site preparation and excavation work.", img: "images/placeholder.jfif", included: true, price: 0 },
      { id: "reinforced_steel", title: "Reinforced Steel", desc: "Steel reinforcement for structural integrity.", img: "images/placeholder.jfif", included: true, price: 0 },
      { id: "plumbing_electric", title: "Plumbing & Electric", desc: "Complete plumbing and electrical installation.", img: "images/placeholder.jfif", included: true, price: 0 },
      { id: "shotcrete", title: "Shotcrete", desc: "Concrete application for pool shell.", img: "images/placeholder.jfif", included: true, price: 0 },
      { id: "ceramic_tile", title: "Ceramic/Porcelain Tile Installation", desc: "Professional tile installation service.", img: "images/placeholder.jfif", included: true, price: 0 },
      { id: "coping_installation", title: "Coping Installation", desc: "Pool edge coping installation.", img: "images/placeholder.jfif", included: true, price: 0 },
      { id: "equipment_operation", title: "Equipment Required for Operation", desc: "All necessary operational equipment.", img: "images/placeholder.jfif", included: true, price: 0 },
      { id: "white_plaster", title: "White Plaster Finish", desc: "Standard white plaster pool finish.", img: "images/placeholder.jfif", included: true, price: 0 },
      { id: "warranties", title: "Warranties", desc: "Comprehensive warranty coverage.", img: "images/placeholder.jfif", included: true, price: 0 }
    ];
    // --- ДАННЫЕ ДЛЯ PLANNING ---
    const planningOptions = [
      { id: "permits", title: "Permits", desc: "Building permits and approvals required.", img: "images/placeholder.jfif", included: false, price: 0 },
      { id: "small_access", title: "Small Access", desc: "Limited site access considerations.", img: "images/placeholder.jfif", included: false, price: 0 },
      { id: "rock_dig", title: "Rock Dig", desc: "Rock excavation and removal.", img: "images/placeholder.jfif", included: false, price: 0 },
      { id: "hillside", title: "Hillside", desc: "Sloped site considerations.", img: "images/placeholder.jfif", included: false, price: 0 },
      { id: "caissons", title: "Caissons", desc: "Foundation caissons for stability.", img: "images/placeholder.jfif", included: false, price: 0 },
      { id: "retaining_wall", title: "Retaining Wall", desc: "Retaining wall construction.", img: "images/placeholder.jfif", included: false, price: 0 },
      { id: "pool_fence", title: "Pool Fence", desc: "Safety fencing requirements.", img: "images/placeholder.jfif", included: false, price: 0 },
      { id: "easements", title: "Easements", desc: "Property easement considerations.", img: "images/placeholder.jfif", included: false, price: 0 },
      { id: "hoa", title: "Home Owner's Association (HOA)", desc: "HOA approval and requirements.", img: "images/placeholder.jfif", included: false, price: 0 }
    ];
    let selectedPlanning = [];
    // --- ДАННЫЕ ДЛЯ ESTIMATED COST ---
    // Функция для расчета общей стоимости
    function calculateTotalCost() {
      let breakdown = {};
      let total = 0;
      let length, width, depth;
      // 1. Определяем размеры
      if (selectedMaterial === 'fibreglass' && selectedDesign) {
        const model = fibreglassModels.find(m => m.id === selectedDesign);
        if (model && model.size) {
          const match = model.size.match(/(\d+\.?\d*)m x (\d+\.?\d*)m x (\d+\.?\d*)m/);
          if (match) {
            length = parseFloat(match[1]);
            width = parseFloat(match[2]);
            depth = parseFloat(match[3]);
          }
        }
        breakdown['construction'] = {
          title: 'Construction (Fibreglass)',
          cost: priceConfig.FIBREGLASS_BASE,
          description: 'Fibreglass pool shell and structural work',
          included: false,
          removable: false,
          id: 'construction'
        };
        total += priceConfig.FIBREGLASS_BASE;
      } else if (selectedMaterial === 'concrete' && selectedShape) {
        length = concreteDims.length;
        width = concreteDims.width;
        depth = concreteDims.depth;
        // Стоимость чаши рассчитывается по объёму (пример: цена за м³)
        const shellVolume = length * width * depth;
        const shellCost = shellVolume * (priceConfig.CONCRETE_SHELL_PER_M3 || 3500); // добавить в priceConfig
        breakdown['construction'] = {
          title: 'Construction (Concrete)',
          cost: shellCost,
          description: `Concrete pool shell (${shellVolume.toFixed(1)} m³)`,
          included: false,
          removable: false,
          id: 'construction'
        };
        total += shellCost;
      }
      // 2. Плитка
      if (length && width) {
        const tile = calcTileCost(length, width);
        breakdown['tile'] = {
          title: 'Tile',
          cost: tile,
          description: `Tile for ${(length * width).toFixed(1)} m²`,
          included: false,
          removable: false,
          id: 'tile'
        };
        total += tile;
      }
      // 3. Парапет (Finishes Coping)
      if (selectedCoping) {
        const opt = finishesCoping.find(o => o.id === selectedCoping);
        breakdown['finishesCoping'] = {
          title: opt.title,
          cost: opt.included ? 0 : opt.price,
          description: opt.desc,
          included: !!opt.included,
          removable: !opt.included,
          id: opt.id
        };
        total += opt.included ? 0 : opt.price;
      }
      // 4. Внутренняя отделка (Finishes Internal)
      if (selectedInternal) {
        const opt = finishesInternal.find(o => o.id === selectedInternal);
        breakdown['finishesInternal'] = {
          title: opt.title,
          cost: opt.included ? 0 : opt.price,
          description: opt.desc,
          included: !!opt.included,
          removable: !opt.included,
          id: opt.id
        };
        total += opt.included ? 0 : opt.price;
      }
      // 5. Земляные работы
      if (length && width && depth) {
        const excavation = calcExcavationCost(length, width, depth);
        breakdown['excavation'] = {
          title: 'Excavation',
          cost: excavation,
          description: `Excavation for ${(length * width * depth).toFixed(1)} m³`,
          included: false,
          removable: false,
          id: 'excavation'
        };
        total += excavation;
      }
      // 6. Бетонирование (Concrete)
      if (length && width) {
        const concrete = calcConcreteCost(length, width);
        breakdown['concrete'] = {
          title: 'Concrete',
          cost: concrete,
          description: `Concrete for ${(length * width).toFixed(1)} m²`,
          included: false,
          removable: false,
          id: 'concrete'
        };
        total += concrete;
      }
      // 7. Электрика/коммуникации (фикс, всегда включено)
      breakdown['electrical'] = {
        title: 'Electrical & Plumbing',
        cost: priceConfig.ELECTRICAL,
        description: 'Electrical and plumbing installation (always included)',
        included: true,
        removable: false,
        id: 'electrical'
      };
      total += priceConfig.ELECTRICAL;
      // 8. Оборудование (Equipment)
      if (selectedEquipment) {
        const opt = equipmentOptions.find(o => o.id === selectedEquipment);
        breakdown['equipment'] = {
          title: opt.title,
          cost: opt.included ? 0 : opt.price,
          description: opt.desc,
          included: !!opt.included,
          removable: !opt.included,
          id: opt.id
        };
        total += opt.included ? 0 : opt.price;
      }
      // 9. Ландшафтный дизайн (Hardscape)
      if (selectedHardscape) {
        const opt = hardscapeOptions.find(o => o.id === selectedHardscape);
        breakdown['hardscape'] = {
          title: opt.title,
          cost: opt.included ? 0 : opt.price,
          description: opt.desc,
          included: !!opt.included,
          removable: !opt.included,
          id: opt.id
        };
        total += opt.included ? 0 : opt.price;
      }
      // 10. Крышка (Cover)
      if (selectedCover) {
        const opt = coverOptions.find(o => o.id === selectedCover);
        breakdown['cover'] = {
          title: opt.title,
          cost: opt.included ? 0 : opt.price,
          description: opt.desc,
          included: !!opt.included,
          removable: !opt.included,
          id: opt.id
        };
        total += opt.included ? 0 : opt.price;
      }
      // 11. Amenities (множественный выбор)
      if (selectedAmenities && selectedAmenities.length > 0) {
        selectedAmenities.forEach(aid => {
          const opt = amenitiesOptions.find(o => o.id === aid);
          breakdown[`amenity_${aid}`] = {
            title: opt.title,
            cost: opt.included ? 0 : opt.price,
            description: opt.desc,
            included: !!opt.included,
            removable: !opt.included,
            id: opt.id
          };
          total += opt.included ? 0 : opt.price;
        });
      }
      // 12. Included Options (всегда показывать все)
      includedOptions.forEach(opt => {
        breakdown[`included_${opt.id}`] = {
          title: opt.title,
          cost: 0,
          description: opt.desc,
          included: true,
          removable: false,
          id: opt.id
        };
      });
      return { total, breakdown };
    }
    // Функции для кнопок в шаге 9
    function getConsultation() {
      alert('Thank you for your interest! Our team will contact you soon for a detailed consultation.');
      // Здесь можно добавить интеграцию с CRM или отправку формы
    }
    
    function addToCart() {
      alert('Pool package added to cart! Redirecting to checkout...');
      // Здесь можно добавить интеграцию с Shopify или другой e-commerce платформой
    }
    
    function editOptions() {
      // Возвращаемся к шагу 6 (Amenities) для редактирования опций
      stepIndex = 6;
      renderStep();
    }
    
    // --- SVG визуализация для concrete ---
    function renderPoolSVG(shape, length, width, depth) {
      // Фиксированные размеры SVG
      const maxW = 340, maxH = 180;
      // Пропорции
      let l = Math.max(4, Math.min(50, length));
      let w = Math.max(2, Math.min(20, width));
      // Масштабирование (чтобы всегда вписывалось в SVG)
      let scale = Math.min((maxW-40) / l, (maxH-40) / w);
      let svgW = maxW, svgH = maxH;
      let poolW = l * scale, poolH = w * scale;
      let x = (svgW - poolW) / 2, y = (svgH - poolH) / 2;
      // 3D эффект: эллипс-дно
      let d = Math.max(1, Math.min(3, depth));
      let depthPx = 18 + (d-1)*10;
      let grad = 'url(#poolGrad)';
      let shadow = 'filter: drop-shadow(0 10px 24px #1786f933);';
      // Форма
      let poolShape = '';
      let bottomShape = '';
      if (shape === 'rectangle') {
        poolShape = `<rect x="${x}" y="${y}" width="${poolW}" height="${poolH}" rx="18" fill="${grad}" stroke="#1786f9" stroke-width="3" style="${shadow}"/>`;
        bottomShape = `<ellipse cx="${svgW/2}" cy="${y+poolH+depthPx/2}" rx="${poolW/2-8}" ry="${depthPx/2}" fill="#b3d6f7" opacity="0.45"/>`;
      } else if (shape === 'oval') {
        poolShape = `<ellipse cx="${svgW/2}" cy="${svgH/2}" rx="${poolW/2}" ry="${poolH/2}" fill="${grad}" stroke="#1786f9" stroke-width="3" style="${shadow}"/>`;
        bottomShape = `<ellipse cx="${svgW/2}" cy="${svgH/2+poolH/2}" rx="${poolW/2-8}" ry="${depthPx/2}" fill="#b3d6f7" opacity="0.45"/>`;
      } else if (shape === 'square') {
        let side = Math.min(poolW, poolH);
        let sx = (svgW-side)/2, sy = (svgH-side)/2;
        poolShape = `<rect x="${sx}" y="${sy}" width="${side}" height="${side}" rx="14" fill="${grad}" stroke="#1786f9" stroke-width="3" style="${shadow}"/>`;
        bottomShape = `<ellipse cx="${svgW/2}" cy="${sy+side+depthPx/2}" rx="${side/2-8}" ry="${depthPx/2}" fill="#b3d6f7" opacity="0.45"/>`;
      }
      // Градиент
      let defs = `<defs><linearGradient id="poolGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#eaf6ff"/><stop offset="100%" stop-color="#1786f9"/></linearGradient></defs>`;
      // Размеры
      let label = `<text x="${svgW/2}" y="${y+poolH/2}" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold" dy=".3em">${l}m × ${w}m</text>`;
      // Глубина
      let depthLabel = `<text x="${svgW-12}" y="${svgH-12}" text-anchor="end" fill="#fff" font-size="13" font-weight="bold">Depth: ${d}m</text>`;
      return `<div style="width:100%;max-width:${maxW}px;margin:0 auto;">
        <svg width="100%" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" style="display:block;">
          ${defs}
          <g>
            ${bottomShape}
            ${poolShape}
            ${label}
            ${depthLabel}
          </g>
        </svg>
      </div>`;
    }
    // --- SVG визуализация для Concrete pool (Top view и Side view) ---
    function renderConcreteSVGs(shape, length, width, depth) {
      // Контейнеры для SVG
      const topView = document.getElementById('svg-top-view');
      const sideView = document.getElementById('svg-side-view');
      if (!topView || !sideView) return;
      // --- Пропорции и размеры SVG ---
      const maxW = 340, maxH = 180;
      // Для top view: длина по горизонтали, ширина по вертикали
      let l = Math.max(2, Math.min(50, length));
      let w = Math.max(2, Math.min(20, width));
      let scale = Math.min((maxW-40) / l, (maxH-40) / w);
      let svgW = maxW, svgH = maxH;
      let poolW = l * scale, poolH = w * scale;
      let x = (svgW - poolW) / 2, y = (svgH - poolH) / 2;
      // --- Top view SVG ---
      let poolShape = '', outline = '', gradId = 'poolGradTop';
      if (shape === 'rectangle') {
        poolShape = `<rect x="${x}" y="${y}" width="${poolW}" height="${poolH}" rx="18" fill="url(#${gradId})" stroke="#0797ee" stroke-width="4" filter="drop-shadow(0 4px 16px #0797ee22)"/>`;
        outline = '';
      } else if (shape === 'oval') {
        poolShape = `<ellipse cx="${svgW/2}" cy="${svgH/2}" rx="${poolW/2}" ry="${poolH/2}" fill="url(#${gradId})" stroke="#0797ee" stroke-width="4" filter="drop-shadow(0 4px 16px #0797ee22)"/>`;
        outline = '';
      } else if (shape === 'square') {
        let side = Math.min(poolW, poolH);
        let sx = (svgW-side)/2, sy = (svgH-side)/2;
        poolShape = `<rect x="${sx}" y="${sy}" width="${side}" height="${side}" rx="16" fill="url(#${gradId})" stroke="#0797ee" stroke-width="4" filter="drop-shadow(0 4px 16px #0797ee22)"/>`;
        outline = '';
      }
      // --- Dimension labels (Top view) ---
      let dimLabels = `
        <text x="${svgW/2}" y="${y-10}" text-anchor="middle" fill="#0797ee" font-size="15" font-family="Arial, sans-serif">${l.toFixed(1)}m</text>
        <text x="${x-8}" y="${svgH/2}" text-anchor="end" fill="#0797ee" font-size="15" font-family="Arial, sans-serif" dy=".3em">${w.toFixed(1)}m</text>
      `;
      // --- Градиент ---
      let grad = `<defs><linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#b3e6ff"/><stop offset="100%" stop-color="#0797ee"/></linearGradient></defs>`;
      // --- SVG Top view ---
      topView.innerHTML = `<svg width="100%" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" style="display:block;max-width:100%;border-radius:18px;background:#f9fafc;">
        ${grad}
        ${poolShape}
        ${outline}
        ${dimLabels}
      </svg>`;
      // --- Side view SVG ---
      // Глубина: от 1 до 3 м, пропорционально maxH
      const sideW = 220, sideH = 80, sideX = (svgW-sideW)/2, sideY = 10;
      let d = Math.max(1, Math.min(3, depth));
      let depthPx = ((d-1)/(3-1)) * (sideH-24) + 24; // min 24px, max sideH
      let gradId2 = 'poolGradSide';
      let poolRect = `<rect x="${sideX}" y="${sideY}" width="${sideW}" height="${sideH}" rx="18" fill="url(#${gradId2})" stroke="#0797ee" stroke-width="4" filter="drop-shadow(0 4px 16px #0797ee22)"/>`;
      let waterRect = `<rect x="${sideX+8}" y="${sideY+sideH-depthPx}" width="${sideW-16}" height="${depthPx}" rx="10" fill="url(#${gradId2})" opacity="0.85"/>`;
      // --- Dimension label (Side view) ---
      let dimLabelSide = `<text x="${sideX+sideW+8}" y="${sideY+sideH-depthPx/2}" fill="#0797ee" font-size="15" font-family="Arial, sans-serif" dy=".3em">${d.toFixed(1)}m</text>`;
      let grad2 = `<defs><linearGradient id="${gradId2}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#b3e6ff"/><stop offset="100%" stop-color="#0797ee"/></linearGradient></defs>`;
      // --- SVG Side view ---
      sideView.innerHTML = `<svg width="100%" height="${sideH+sideY*2}" viewBox="0 0 ${svgW} ${sideH+sideY*2}" style="display:block;max-width:100%;border-radius:18px;background:#f9fafc;">
        ${grad2}
        ${poolRect}
        ${waterRect}
        ${dimLabelSide}
      </svg>`;
      // TODO: добавить анимацию изменения размеров и плавные переходы
      // TODO: добавить более сложные формы (freeform, kidney и т.д.)
    }
    // --- WOW SVG визуализация для Concrete pool (Top view и Side view, с анимацией и эффектами) ---
    function renderConcreteWOWSVGs(shape, length, width, depth) {
      // Контейнеры для SVG
      const topView = document.getElementById('svg-top-view');
      const sideView = document.getElementById('svg-side-view');
      if (!topView || !sideView) return;
      // --- Пропорции и размеры SVG ---
      const maxW = 340, maxH = 180;
      // Для top view: длина по горизонтали, ширина по вертикали
      let l = Math.max(2, Math.min(50, length));
      let w = Math.max(2, Math.min(20, width));
      let d = Math.max(1, Math.min(3, depth));
      let scale = Math.min((maxW-40) / l, (maxH-40) / w);
      let svgW = maxW, svgH = maxH;
      let poolW = l * scale, poolH = w * scale;
      let x = (svgW - poolW) / 2, y = (svgH - poolH) / 2;
      // --- WOW Top view SVG ---
      let gradId = 'poolGradTopWOW';
      let shadow = 'filter: drop-shadow(0 10px 24px #1786f955);';
      let glare = `<ellipse cx="${svgW/2}" cy="${y+poolH/2-10}" rx="${poolW/2-12}" ry="${poolH/6}" fill="#fff" opacity="0.18">
        <animate attributeName="opacity" values="0.18;0.05;0.18" dur="2.5s" repeatCount="indefinite"/>
      </ellipse>`;
      let ripple = `<ellipse cx="${svgW/2}" cy="${svgH/2}" rx="${poolW/2-8}" ry="${poolH/2-8}" fill="none" stroke="#fff" stroke-width="2" opacity="0.13">
        <animate attributeName="rx" values="${poolW/2-8};${poolW/2-4};${poolW/2-8}" dur="2.2s" repeatCount="indefinite"/>
        <animate attributeName="ry" values="${poolH/2-8};${poolH/2-4};${poolH/2-8}" dur="2.2s" repeatCount="indefinite"/>
      </ellipse>`;
      let poolShape = '', outline = '';
      if (shape === 'rectangle') {
        poolShape = `<rect x="${x}" y="${y}" width="${poolW}" height="${poolH}" rx="18" fill="url(#${gradId})" stroke="#1786f9" stroke-width="4" style="${shadow}"/>`;
        outline = '';
      } else if (shape === 'oval') {
        poolShape = `<ellipse cx="${svgW/2}" cy="${svgH/2}" rx="${poolW/2}" ry="${poolH/2}" fill="url(#${gradId})" stroke="#1786f9" stroke-width="4" style="${shadow}"/>`;
        outline = '';
      } else if (shape === 'square') {
        let side = Math.min(poolW, poolH);
        let sx = (svgW-side)/2, sy = (svgH-side)/2;
        poolShape = `<rect x="${sx}" y="${sy}" width="${side}" height="${side}" rx="14" fill="url(#${gradId})" stroke="#1786f9" stroke-width="4" style="${shadow}"/>`;
        outline = '';
      }
      // --- Dimension labels (Top view) ---
      let dimLabelL = `<g><line x1="${x}" y1="${y+poolH+16}" x2="${x+poolW}" y2="${y+poolH+16}" stroke="#1786f9" stroke-width="2" marker-end="url(#arrow)" marker-start="url(#arrow)"/>
        <text x="${svgW/2}" y="${y+poolH+32}" text-anchor="middle" fill="#1786f9" font-size="15" font-weight="bold">${l} m</text></g>`;
      let dimLabelW = `<g><line x1="${x-16}" y1="${y}" x2="${x-16}" y2="${y+poolH}" stroke="#1786f9" stroke-width="2" marker-end="url(#arrow)" marker-start="url(#arrow)"/>
        <text x="${x-28}" y="${svgH/2}" text-anchor="middle" fill="#1786f9" font-size="15" font-weight="bold" transform="rotate(-90,${x-28},${svgH/2})">${w} m</text></g>`;
      // --- SVG defs ---
      let defs = `<defs>
        <linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#eaf6ff"/>
          <stop offset="100%" stop-color="#1786f9"/>
        </linearGradient>
        <marker id="arrow" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto" markerUnits="strokeWidth">
          <path d="M0,0 L8,4 L0,8 L2,4 Z" fill="#1786f9" />
        </marker>
      </defs>`;
      // --- WOW Top view SVG ---
      topView.innerHTML = `<svg width="100%" height="${svgH+48}" viewBox="0 0 ${svgW} ${svgH+48}" style="display:block;max-width:100%;border-radius:18px;background:#f9fafc;">
        ${defs}
        <g>
          ${poolShape}
          ${glare}
          ${ripple}
          ${dimLabelL}
          ${dimLabelW}
        </g>
      </svg>`;
      // --- WOW Side view SVG ---
      // Side view: длина по горизонтали, глубина по вертикали
      let sideW = poolW, sideH = 80, sideY = 24;
      let grad2 = `<defs><linearGradient id="poolGradSideWOW" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#eaf6ff"/><stop offset="100%" stop-color="#1786f9"/></linearGradient></defs>`;
      let poolRect = `<rect x="${x}" y="${sideY}" width="${sideW}" height="${sideH}" rx="12" fill="url(#poolGradSideWOW)" stroke="#1786f9" stroke-width="3" style="${shadow}"/>`;
      let waterRect = `<rect x="${x+4}" y="${sideY+8}" width="${sideW-8}" height="${sideH-16}" rx="8" fill="#b3d6f7" opacity="0.45"/>
        <ellipse cx="${svgW/2}" cy="${sideY+sideH-8}" rx="${sideW/2-12}" ry="8" fill="#1786f9" opacity="0.18">
          <animate attributeName="opacity" values="0.18;0.05;0.18" dur="2.5s" repeatCount="indefinite"/>
        </ellipse>`;
      let wave = `<path d="M${x+12},${sideY+sideH-16} Q${x+sideW/4},${sideY+sideH-24} ${x+sideW/2},${sideY+sideH-16} T${x+sideW-12},${sideY+sideH-16}" stroke="#fff" stroke-width="2" fill="none">
        <animate attributeName="d" values="M${x+12},${sideY+sideH-16} Q${x+sideW/4},${sideY+sideH-24} ${x+sideW/2},${sideY+sideH-16} T${x+sideW-12},${sideY+sideH-16};M${x+12},${sideY+sideH-16} Q${x+sideW/4},${sideY+sideH-8} ${x+sideW/2},${sideY+sideH-24} T${x+sideW-12},${sideY+sideH-16};M${x+12},${sideY+sideH-16} Q${x+sideW/4},${sideY+sideH-24} ${x+sideW/2},${sideY+sideH-16} T${x+sideW-12},${sideY+sideH-16}" dur="2.2s" repeatCount="indefinite"/>
      </path>`;
      let dimLabelSide = `<g><line x1="${x}" y1="${sideY+sideH+16}" x2="${x+sideW}" y2="${sideY+sideH+16}" stroke="#1786f9" stroke-width="2" marker-end="url(#arrow)" marker-start="url(#arrow)"/>
        <text x="${svgW/2}" y="${sideY+sideH+32}" text-anchor="middle" fill="#1786f9" font-size="15" font-weight="bold">${l} m</text>
        <line x1="${x+sideW+16}" y1="${sideY}" x2="${x+sideW+16}" y2="${sideY+sideH}" stroke="#1786f9" stroke-width="2" marker-end="url(#arrow)" marker-start="url(#arrow)"/>
        <text x="${x+sideW+28}" y="${sideY+sideH/2}" text-anchor="middle" fill="#1786f9" font-size="15" font-weight="bold" transform="rotate(-90,${x+sideW+28},${sideY+sideH/2})">${d} m</text></g>`;
      sideView.innerHTML = `<svg width="100%" height="${sideH+sideY*2+48}" viewBox="0 0 ${svgW} ${sideH+sideY*2+48}" style="display:block;max-width:100%;border-radius:18px;background:#f9fafc;">
        ${grad2}
        <g>
          ${poolRect}
          ${waterRect}
          ${wave}
          ${dimLabelSide}
        </g>
      </svg>`;
    }
    // --- РЕНДЕР СТЕППЕРА ---
    // const stepper = document.getElementById('stepper');
    // function renderStepper() {
    //   stepper.innerHTML = steps.map((step, idx) => `
    //     <div class="stepper-circle${idx === Math.floor(stepIndex) ? ' active' : ''}" data-step="${idx}">
    //       <span>${idx + 1}</span>
    //       <div class="stepper-label">${step.label}</div>
    //     </div>
    //   `).join('');
    //   // Кликабельность stepper
    //   document.querySelectorAll('.stepper-circle').forEach((el, idx) => {
    //     el.onclick = () => { stepIndex = idx; renderStep(); };
    //   });
    // }
    // --- РЕНДЕР КАРТОЧЕК ---
    const grid = document.getElementById('designGrid');
    const concreteForm = document.getElementById('concreteForm');
        updateNextBtn();
        if (stepIndex === 1) {
          // Шаг 2: Дизайн
          if (selectedMaterial === 'concrete') {
            grid.style.display = 'none';
            concreteForm.style.display = '';
          // --- UI: Concrete pool shapes ---
          let shapeHtml = concreteShapes.map(s => `
            <div class="design-card${selectedShape === s.id ? ' selected' : ''}" tabindex="0" data-id="${s.id}">
              <div class="card-content">
                <img src="${s.img}" alt="${s.title}" class="design-img" />
                <div class="card-title">${s.title}</div>
                <div class="card-desc">${s.desc}</div>
              </div>
              <!-- LEARN MORE BUTTON (универсально) -->
              <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${s.title.replace(/'/g, "&#39;")}', 'Demo info about ${s.title}. (TODO: Inject real content here)')">Learn More</button>
              <!-- END LEARN MORE BUTTON -->
        </div>
      `).join('');
          // --- После выбора формы показываем размеры и визуализацию ---
          let paramsAndVisual = '';
          if (selectedShape) {
            // --- Блок выбора размеров ---
            let paramFields = [
              { key: 'length', label: 'Length', min: 2, max: 50, step: 0.1, value: concreteDims.length },
              { key: 'width', label: 'Width', min: 2, max: 20, step: 0.1, value: concreteDims.width },
              { key: 'depth', label: 'Depth', min: 1, max: 3, step: 0.1, value: concreteDims.depth }
            ];
            let sliders = paramFields.map(p => `
              <div class="concrete-param-row">
                <label class="concrete-label">${p.label}:</label>
                <input type="number" class="concrete-num" id="num-${p.key}" min="${p.min}" max="${p.max}" step="${p.step}" value="${p.value}" autocomplete="off"> м
                <input type="range" class="concrete-slider" id="slider-${p.key}" min="${p.min}" max="${p.max}" step="${p.step}" value="${p.value}">
              </div>
            `).join('');
            // --- WOW SVG визуализация ---
            let visualPreview = `
              <div class="visual-preview-container">
                <div class="svg-label">Top view</div>
                <div id="svg-top-view"></div>
                <div class="svg-label">Side view (depth)</div>
                <div id="svg-side-view"></div>
              </div>
            `;
            let perim = 2 * (Number(concreteDims.length) + Number(concreteDims.width));
            let vol = (Number(concreteDims.length) * Number(concreteDims.width) * Number(concreteDims.depth)).toFixed(2);
            let calcHtml = `<div style="margin:18px 0 0 0;text-align:center;color:#1786f9;font-size:1.1em;">Perimeter: <b>${perim} m</b> &nbsp; | &nbsp; Volume: <b>${vol} m³</b></div>`;
            paramsAndVisual = `
              <div style="min-height:140px;display:flex;flex-direction:column;justify-content:center;max-width:420px;margin:0 auto;">
                <div class="concrete-params-block">
                  ${sliders}
                </div>
                ${visualPreview}
                ${calcHtml}
              </div>
            `;
          }
          concreteForm.innerHTML = `
            <div class="design-grid">${shapeHtml}</div>
            ${paramsAndVisual}
          `;
          // --- События выбора формы ---
          document.querySelectorAll('#concreteForm .design-card').forEach(card => {
            card.onclick = () => { selectedShape = card.dataset.id; renderStep(); updateNextBtn(); };
            card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { selectedShape = card.dataset.id; renderStep(); updateNextBtn(); } };
          });
          // --- События для input/range ---
          if (selectedShape) {
            let paramFields = [
              { key: 'length', min: 2, max: 50, step: 0.1 },
              { key: 'width', min: 2, max: 20, step: 0.1 },
              { key: 'depth', min: 1, max: 3, step: 0.1 }
            ];
            paramFields.forEach(p => {
              const num = document.getElementById(`num-${p.key}`);
              const slider = document.getElementById(`slider-${p.key}`);
              slider.oninput = e => {
                let v = parseFloat(e.target.value);
                if (isNaN(v)) v = p.min;
                num.value = v;
                concreteDims[p.key] = v;
                let perim = 2 * (Number(concreteDims.length) + Number(concreteDims.width));
                let vol = (Number(concreteDims.length) * Number(concreteDims.width) * Number(concreteDims.depth)).toFixed(2);
                document.querySelector('.concrete-params-block').nextElementSibling.nextElementSibling.innerHTML = `Perimeter: <b>${perim} m</b> &nbsp; | &nbsp; Volume: <b>${vol} m³</b>`;
                renderConcreteWOWSVGs(selectedShape, concreteDims.length, concreteDims.width, concreteDims.depth);
              };
              num.oninput = e => {
                slider.value = num.value;
                concreteDims[p.key] = parseFloat(num.value) || '';
                let perim = 2 * (Number(concreteDims.length) + Number(concreteDims.width));
                let vol = (Number(concreteDims.length) * Number(concreteDims.width) * Number(concreteDims.depth)).toFixed(2);
                document.querySelector('.concrete-params-block').nextElementSibling.nextElementSibling.innerHTML = `Perimeter: <b>${perim} m</b> &nbsp; | &nbsp; Volume: <b>${vol} m³</b>`;
                renderConcreteWOWSVGs(selectedShape, concreteDims.length, concreteDims.width, concreteDims.depth);
              };
              num.onblur = e => {
                let v = parseFloat(num.value);
                if (isNaN(v)) v = p.min;
                if (v < p.min) v = p.min;
                if (v > p.max) v = p.max;
                num.value = v;
                slider.value = v;
                concreteDims[p.key] = v;
                renderStep();
              };
              num.onkeydown = e => { if (e.key === 'Enter') num.blur(); };
            });
            // --- WOW SVG рендеринг ---
            renderConcreteWOWSVGs(selectedShape, concreteDims.length, concreteDims.width, concreteDims.depth);
          }
          // Всегда обновляем состояние NEXT после рендера блока выбора формы
          updateNextBtn();
        } else {
          grid.style.display = '';
          concreteForm.style.display = 'none';
          let models = selectedMaterial === 'fibreglass' ? fibreglassModels : [
            { id: "vinyl-std", title: "Vinyl Standard", desc: "Standard vinyl pool", img: "images/placeholder.jfif", link: { label: "Learn more", url: "#" }, size: null }
          ];
          grid.innerHTML = models.map(m => `
            <div class="design-card${selectedDesign === m.id ? ' selected' : ''}" tabindex="0" data-id="${m.id}">
              <div class="card-content">
                <img src="${m.img}" alt="${m.title}" class="design-img" />
                <div class="card-title">${m.title}</div>
                <div class="card-desc">${m.desc}</div>
                <div class="pool-size">${
                  m.size
                    ? (Array.isArray(m.size)
                        ? m.size.map(sz => sz || 'Размер уточняется').join('<br>')
                        : m.size)
                    : 'Размер уточняется'
                }</div>
              </div>
              <!-- LEARN MORE BUTTON (универсально) -->
              <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${m.title.replace(/'/g, "&#39;")}', 'Demo info about ${m.title}. (TODO: Inject real content here)')">Learn More</button>
              <!-- END LEARN MORE BUTTON -->
            </div>
          `).join('');
          document.querySelectorAll('.design-card').forEach(card => {
            card.onclick = () => { selectedDesign = card.dataset.id; renderStep(); updateNextBtn(); };
            card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { selectedDesign = card.dataset.id; renderStep(); updateNextBtn(); } };
          });
          updateNextBtn();
        }
      } else if (stepIndex === 2) {
        grid.style.display = '';
        concreteForm.style.display = 'none';
        grid.innerHTML = equipmentOptions.map(opt => `
          <div class="design-card${selectedEquipment === opt.id ? ' selected' : ''}" tabindex="0" data-id="${opt.id}">
            <div class="card-content">
              ${opt.badge ? `<div class="badge">${opt.badge}</div>` : ''}
              <img src="${opt.img}" alt="${opt.title}" class="design-img" />
              <div class="card-title">${opt.title}</div>
              <div class="card-desc">${opt.desc}</div>
            </div>
            <!-- LEARN MORE BUTTON (универсально) -->
            <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
            <!-- END LEARN MORE BUTTON -->
          </div>
        `).join('');
        document.querySelectorAll('.design-card').forEach(card => {
          card.onclick = () => { selectedEquipment = card.dataset.id; renderStep(); updateNextBtn(); };
          card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { selectedEquipment = card.dataset.id; renderStep(); updateNextBtn(); } };
        });
        updateNextBtn();
      } else if (stepIndex === 3) {
        grid.style.display = '';
        concreteForm.style.display = 'none';
        // --- STEP 4: Finishes (Coping + Internal) ---
        grid.innerHTML = `
          <div class="finishes-container">
            <!-- Coping Material GROUP START -->
            <div class="finish-group">
              <div class="finish-title">Coping Material</div>
              <div class="design-grid">
                ${finishesCoping.map(opt => `
                  <div class="finishes-card${selectedCoping === opt.id ? ' selected' : ''}"
                       tabindex="0" role="button" aria-checked="${selectedCoping === opt.id}"
                       data-id="${opt.id}" data-group="coping">
                    <div class="card-content">
                      ${opt.badge ? `<div class="badge">${opt.badge}</div>` : ''}
                      <img src="${opt.img}" alt="${opt.title}" class="finishes-img" />
                      <div class="card-title">${opt.title}</div>
                      <div class="card-desc">${opt.desc}</div>
                    </div>
                    <!-- LEARN MORE BUTTON (универсально) -->
                    <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
                    <!-- END LEARN MORE BUTTON -->
                  </div>
                `).join('')}
              </div>
            </div>
            <!-- Coping Material GROUP END -->
            <!-- Internal Finish GROUP START -->
            <div class="finish-group">
              <div class="finish-title">Internal Finish</div>
              <div class="design-grid">
                ${finishesInternal.map(opt => `
                  <div class="finishes-card${selectedInternal === opt.id ? ' selected' : ''}"
                       tabindex="0" role="button" aria-checked="${selectedInternal === opt.id}"
                       data-id="${opt.id}" data-group="internal">
                    <div class="card-content">
                      ${opt.badge ? `<div class="badge">${opt.badge}</div>` : ''}
                      <img src="${opt.img}" alt="${opt.title}" class="finishes-img" />
                      <div class="card-title">${opt.title}</div>
                      <div class="card-desc">${opt.desc}</div>
                    </div>
                    <!-- LEARN MORE BUTTON (универсально) -->
                    <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
                    <!-- END LEARN MORE BUTTON -->
                  </div>
                `).join('')}
              </div>
            </div>
            <!-- Internal Finish GROUP END -->
          </div>
        `;
        // --- Обработчики выбора для finishes-card ---
        document.querySelectorAll('.finishes-card[data-group="coping"]').forEach(card => {
          card.onclick = () => {
            selectedCoping = card.dataset.id;
            renderStep();
            updateNextBtn();
          };
          card.onkeydown = e => {
            if (e.key === 'Enter' || e.key === ' ') {
              selectedCoping = card.dataset.id;
              renderStep();
              updateNextBtn();
            }
          };
        });
        document.querySelectorAll('.finishes-card[data-group="internal"]').forEach(card => {
          card.onclick = () => {
            selectedInternal = card.dataset.id;
            renderStep();
            updateNextBtn();
          };
          card.onkeydown = e => {
            if (e.key === 'Enter' || e.key === ' ') {
              selectedInternal = card.dataset.id;
              renderStep();
              updateNextBtn();
            }
          };
        });
        updateNextBtn();
      } else if (stepIndex === 4) {
        grid.style.display = '';
        concreteForm.style.display = 'none';
        grid.innerHTML = hardscapeOptions.map(opt => `
          <div class="design-card${selectedHardscape === opt.id ? ' selected' : ''}" tabindex="0" data-id="${opt.id}">
            <div class="card-content">
              <img src="${opt.img}" alt="${opt.title}" class="design-img" />
              <div class="card-title">${opt.title}</div>
              <div class="card-desc">${opt.desc}</div>
            </div>
            <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
          </div>
        `).join('');
        document.querySelectorAll('.design-card').forEach(card => {
          card.onclick = () => { selectedHardscape = card.dataset.id; renderStep(); updateNextBtn(); };
          card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { selectedHardscape = card.dataset.id; renderStep(); updateNextBtn(); } };
        });
        updateNextBtn();
      } else if (stepIndex === 5) {
        grid.style.display = '';
        concreteForm.style.display = 'none';
        grid.innerHTML = coverOptions.map(opt => `
          <div class="design-card${selectedCover === opt.id ? ' selected' : ''}" tabindex="0" data-id="${opt.id}">
            <div class="card-content">
              <img src="${opt.img}" alt="${opt.title}" class="design-img" />
              <div class="card-title">${opt.title}</div>
              <div class="card-desc">${opt.desc}</div>
            </div>
            <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
          </div>
        `).join('');
        document.querySelectorAll('.design-card').forEach(card => {
          card.onclick = () => { selectedCover = card.dataset.id; renderStep(); updateNextBtn(); };
          card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { selectedCover = card.dataset.id; renderStep(); updateNextBtn(); } };
        });
        updateNextBtn();
      } else if (stepIndex === 6) {
        mainTitle = 'SELECT AMENITIES';
        subtitle = 'Choose additional features for your pool. Multiple options can be selected.';
        grid.style.display = '';
        concreteForm.style.display = 'none';
        grid.innerHTML = amenitiesOptions.map(opt => `
          <div class="design-card${selectedAmenities.includes(opt.id) ? ' selected' : ''}" tabindex="0" data-id="${opt.id}">
            <div class="card-content">
              ${opt.badge ? `<div class="badge">${opt.badge}</div>` : ''}
              <img src="${opt.img}" alt="${opt.title}" class="design-img" />
              <div class="card-title">${opt.title}</div>
              <div class="card-desc">${opt.desc}</div>
            </div>
            <!-- LEARN MORE BUTTON (универсально) -->
            <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
            <!-- END LEARN MORE BUTTON -->
          </div>
        `).join('');
        document.querySelectorAll('.design-card').forEach(card => {
          card.onclick = () => {
            if (selectedAmenities.includes(card.dataset.id)) {
              selectedAmenities = selectedAmenities.filter(id => id !== card.dataset.id);
            } else {
              selectedAmenities.push(card.dataset.id);
            }
            renderStep();
            updateNextBtn();
          };
          card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') {
            if (selectedAmenities.includes(card.dataset.id)) {
              selectedAmenities = selectedAmenities.filter(id => id !== card.dataset.id);
            } else {
              selectedAmenities.push(card.dataset.id);
            }
            renderStep();
            updateNextBtn();
          } };
        });
        updateNextBtn();
      } else if (stepIndex === 7) {
        mainTitle = "WHAT'S INCLUDED";
        subtitle = 'All services and materials included in your pool package. Get in touch for detailed information.';
        grid.style.display = '';
        concreteForm.style.display = 'none';
        grid.innerHTML = includedOptions.map(opt => `
          <div class="design-card whats-included" tabindex="0" data-id="${opt.id}">
            <div class="card-content">
              <div class="badge">Included</div>
              <img src="${opt.img}" alt="${opt.title}" class="design-img" />
              <div class="card-title">${opt.title}</div>
              <div class="card-desc">${opt.desc}</div>
            </div>
            <!-- LEARN MORE BUTTON (универсально) -->
            <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
            <!-- END LEARN MORE BUTTON -->
          </div>
        `).join('');
        // Карточки не кликабельны, только для информации
        document.querySelectorAll('.design-card.whats-included').forEach(card => {
          card.style.cursor = 'default';
          card.onclick = null;
          card.onkeydown = null;
        });
        updateNextBtn();
      } else if (stepIndex === 8) {
        mainTitle = "PLANNING";
        subtitle = 'Things to consider for your project. Multiple options can be selected.';
        grid.style.display = '';
        concreteForm.style.display = 'none';
        grid.innerHTML = planningOptions.map(opt => `
          <div class="design-card${selectedPlanning.includes(opt.id) ? ' selected' : ''}" tabindex="0" data-id="${opt.id}">
            <div class="card-content">
              <img src="${opt.img}" alt="${opt.title}" class="design-img" />
              <div class="card-title">${opt.title}</div>
              <div class="card-desc">${opt.desc}</div>
            </div>
            <!-- LEARN MORE BUTTON (универсально) -->
            <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
            <!-- END LEARN MORE BUTTON -->
          </div>
        `).join('');
        document.querySelectorAll('.design-card').forEach(card => {
          card.onclick = () => {
            if (selectedPlanning.includes(card.dataset.id)) {
              selectedPlanning = selectedPlanning.filter(id => id !== card.dataset.id);
            } else {
              selectedPlanning.push(card.dataset.id);
            }
            renderStep();
            updateNextBtn();
          };
          card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') {
            if (selectedPlanning.includes(card.dataset.id)) {
              selectedPlanning = selectedPlanning.filter(id => id !== card.dataset.id);
            } else {
              selectedPlanning.push(card.dataset.id);
            }
            renderStep();
            updateNextBtn();
          } };
        });
        updateNextBtn();
      } else if (stepIndex === 7) {
        stepIndex = 6; renderStep();
      } else if (stepIndex === 8 && selectedPlanning.length) {
        stepIndex = 9; renderStep();
      } else if (stepIndex === 9) {
        mainTitle = "ESTIMATED COST";
        subtitle = 'Your pool package breakdown and total cost estimate.';
        grid.style.display = '';
        concreteForm.style.display = 'none';
        
        const { total, breakdown } = calculateTotalCost();
        const breakdownKeys = Object.keys(breakdown);
        grid.innerHTML = `
          <div style="max-width: 800px; margin: 0 auto; width: 100%;">
            <div style="background: #f8fafc; border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 2px solid #e8f1fb;">
              <h3 style="margin: 0 0 20px 0; color: #0797ee; font-size: 1.3em; text-align: center;">Cost Breakdown</h3>
              ${breakdownKeys.map(key => {
                const item = breakdown[key];
                const isIncluded = item.included;
                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e8f1fb;">
                  <div>
                    <div style="font-weight: 600; color: #2a3a4a; margin-bottom: 4px;">${item.title}</div>
                    <div style="font-size: 0.9em; color: #6a7a8a;">${item.description}</div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-weight: 700; color: #0797ee; font-size: 1.2em;">$${item.cost.toLocaleString()}</span>
                    ${isIncluded ? '<span style="background:#e8f1fb;color:#0797ee;font-size:12px;padding:2px 8px;border-radius:6px;font-weight:600;">Included</span>' : ''}
                    ${!isIncluded && item.removable ? `<button onclick="window.removeBreakdownOption('${key}','${item.id}')" style="background:none;border:none;color:#e96c2c;font-size:1.2em;cursor:pointer;" title="Remove">&#10006;</button>` : ''}
                  </div>
                </div>`;
              }).join('')}
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-top: 2px solid #0797ee; margin-top: 12px;">
                <div style="font-weight: 700; color: #2a3a4a; font-size: 1.3em;">Total Estimated Cost</div>
                <div style="font-weight: 700; color: #0797ee; font-size: 1.5em;">$${total.toLocaleString()}</div>
              </div>
            </div>
            <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
              <button onclick="getConsultation()" style="background: #0797ee; color: white; border: none; padding: 16px 32px; border-radius: 12px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 16px #0797ee33;" onmouseover="this.style.background='#1786f9'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#0797ee'; this.style.transform='translateY(0)'">Get Consultation</button>
              <button onclick="addToCart()" style="background: #e96c2c; color: white; border: none; padding: 16px 32px; border-radius: 12px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 16px #e96c2c33;" onmouseover="this.style.background='#ff7f3f'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#e96c2c'; this.style.transform='translateY(0)'">Add to Cart</button>
            </div>
          </div>
        `;
        
        updateNextBtn();
      }
    function updateNextBtn() {
      if (stepIndex === 0) {
        document.getElementById('nextBtn').disabled = !selectedMaterial;
      } else if (stepIndex === 1) {
        if (selectedMaterial === 'concrete') {
          document.getElementById('nextBtn').disabled = !selectedShape;
        } else {
          document.getElementById('nextBtn').disabled = !selectedDesign;
        }
      } else if (stepIndex === 1.5) {
        document.getElementById('nextBtn').disabled = false;
      } else if (stepIndex === 2) {
        document.getElementById('nextBtn').disabled = !selectedEquipment;
      } else if (stepIndex === 3) {
        document.getElementById('nextBtn').disabled = !(selectedCoping && selectedInternal);
      } else if (stepIndex === 4) {
        document.getElementById('nextBtn').disabled = !selectedHardscape;
      } else if (stepIndex === 5) {
        document.getElementById('nextBtn').disabled = !selectedCover;
      } else if (stepIndex === 6) {
        document.getElementById('nextBtn').disabled = !selectedAmenities.length;
      } else if (stepIndex === 7) {
        document.getElementById('nextBtn').disabled = false;
      } else if (stepIndex === 8) {
        document.getElementById('nextBtn').disabled = !selectedPlanning.length;
      } else if (stepIndex === 9) {
        document.getElementById('nextBtn').style.display = 'none';
      } else {
        // Для всех последующих шагов (если появятся) — NEXT всегда дизабл, если нет выбора (можно расширить по мере добавления шагов)
        document.getElementById('nextBtn').disabled = false;
      }
    }
    // --- NEXT/PREV ---
    document.getElementById('nextBtn').onclick = function() {
      if (stepIndex === 0 && selectedMaterial) { stepIndex = 1; renderStep(); }
      else if (stepIndex === 1) {
        if (selectedMaterial === 'concrete' && selectedShape) { stepIndex = 1.5; renderStep(); }
        else if (selectedMaterial !== 'concrete' && selectedDesign) { stepIndex = 2; renderStep(); }
      } else if (stepIndex === 1.5) {
        stepIndex = 2; renderStep();
      } else if (stepIndex === 2 && selectedEquipment) {
        stepIndex = 3; renderStep();
      } else if (stepIndex === 3 && selectedCoping && selectedInternal) {
        stepIndex = 4; renderStep();
      } else if (stepIndex === 4 && selectedHardscape) {
        stepIndex = 5; renderStep();
      } else if (stepIndex === 5 && selectedCover) {
        stepIndex = 6; renderStep();
      } else if (stepIndex === 6 && selectedAmenities.length) {
        stepIndex = 7; renderStep();
      } else if (stepIndex === 7) {
        stepIndex = 8; renderStep();
      } else if (stepIndex === 8 && selectedPlanning.length) {
        stepIndex = 9; renderStep();
      }
    };
    document.getElementById('prevBtn').onclick = function() {
      if (stepIndex === 1.5) { stepIndex = 1; renderStep(); }
      else if (stepIndex === 1) {
        // При возврате на шаг назад сбрасываем форму, если был concrete
        if (selectedMaterial === 'concrete') selectedShape = null;
        stepIndex = 0; renderStep();
      }
      else if (stepIndex === 2) { stepIndex = 1; renderStep(); }
      else if (stepIndex === 3) { stepIndex = 2; renderStep(); }
      else if (stepIndex === 4) { stepIndex = 3; renderStep(); }
      else if (stepIndex === 5) { stepIndex = 4; renderStep(); }
      else if (stepIndex === 6) { stepIndex = 5; renderStep(); }
      else if (stepIndex === 7) { stepIndex = 6; renderStep(); }
      else if (stepIndex === 8) { stepIndex = 7; renderStep(); }
    };
    // === LEARN MORE MODAL LOGIC (универсально для всех карточек) ===
    // --- Модальное окно и overlay ---
    const modalOverlay = document.getElementById('modalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalDesc = document.getElementById('modalDesc');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalCloseBtn2 = document.getElementById('modalCloseBtn2');
    let lastFocusedBtn = null;
    function openLearnMore(title, desc) {
      modalTitle.textContent = title || 'Learn More';
      modalDesc.textContent = desc || 'Demo info about this option/card. (TODO: Inject real content here)';
      modalOverlay.style.display = 'flex';
      setTimeout(() => modalOverlay.classList.add('active'), 10);
      // Trap focus
      const focusable = modalOverlay.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
      if (focusable.length) focusable[0].focus();
      document.body.style.overflow = 'hidden';
      // Save last focused
      lastFocusedBtn = document.activeElement;
    }
    function closeLearnMore() {
      modalOverlay.classList.remove('active');
      setTimeout(() => { modalOverlay.style.display = 'none'; document.body.style.overflow = ''; }, 300);
      if (lastFocusedBtn) lastFocusedBtn.focus();
    }
    modalCloseBtn.onclick = closeLearnMore;
    modalCloseBtn2.onclick = closeLearnMore;
    modalOverlay.onclick = function(e) {
      if (e.target === modalOverlay) closeLearnMore();
    };
    document.addEventListener('keydown', function(e) {
      if (modalOverlay.style.display === 'flex') {
        if (e.key === 'Escape') closeLearnMore();
        // Trap focus
        const focusable = modalOverlay.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
        if (e.key === 'Tab') {
          if (!focusable.length) return;
          const first = focusable[0], last = focusable[focusable.length-1];
          if (e.shiftKey) { if (document.activeElement === first) { e.preventDefault(); last.focus(); } }
          else { if (document.activeElement === last) { e.preventDefault(); first.focus(); } }
        }
      }
    });
    // === END LEARN MORE MODAL LOGIC ===
    // --- ИНИЦИАЛИЗАЦИЯ ---
    
    // === НОВЫЙ STEPPER ===
    function renderStepper() {
      const bar = document.getElementById('stepperBar');
      bar.innerHTML = '';
      steps.forEach((step, idx) => {
        let state = 'future';
        if (idx < stepIndex) state = 'completed';
        if (idx === stepIndex) state = 'active';
        const stepDiv = document.createElement('div');
        stepDiv.className = `stepper-step ${state}`;
        stepDiv.tabIndex = (state === 'completed' || state === 'active') ? 0 : -1;
        stepDiv.setAttribute('role', 'button');
        if (state === 'completed' || state === 'active') {
          stepDiv.onclick = () => {
            if (idx <= stepIndex) {
              stepIndex = idx;
              renderStep();
            }
          };
        }
        stepDiv.innerHTML = `
          <div class="stepper-circle">${idx+1}</div>
          <div class="stepper-label">${step.label.toUpperCase()}</div>
        `;
        bar.appendChild(stepDiv);
      });
    }
    // ... существующий код ...
    // Вызов рендера степпера теперь через renderStepper() внутри renderStep()
    function renderStep() {
      renderStepper();
      document.getElementById('prevBtn').style.display = stepIndex > 0 ? '' : 'none';
      let mainTitle = 'SELECT POOL MATERIAL';
      let subtitle = 'Choose the type of pool shell that best fits your needs. Only one option can be selected.';
      if (stepIndex === 1) {
        mainTitle = 'SELECT POOL DESIGN';
        subtitle = (selectedMaterial === 'concrete')
          ? 'Choose the shape and set the dimensions for your concrete pool.'
          : 'Choose your preferred pool model. Only one option can be selected.';
      } else if (stepIndex === 2) {
        mainTitle = 'SELECT EQUIPMENT PACKAGE';
        subtitle = 'Choose the equipment package for your pool. Only one option can be selected.';
      } else if (stepIndex === 3) {
        mainTitle = 'SELECT FINISHES';
        subtitle = 'Choose coping material and internal finish. Only one option in each group.';
      } else if (stepIndex === 4) {
        mainTitle = 'SELECT HARDSCAPE';
        subtitle = 'Choose the hardscape material around your pool. Only one option can be selected.';
      } else if (stepIndex === 5) {
        mainTitle = 'SELECT POOL COVER';
        subtitle = 'Choose a cover for your pool. Only one option can be selected.';
      } else if (stepIndex === 6) {
        mainTitle = 'SELECT AMENITIES';
        subtitle = 'Choose additional features for your pool. Multiple options can be selected.';
      } else if (stepIndex === 7) {
        mainTitle = "WHAT'S INCLUDED";
        subtitle = 'All services and materials included in your pool package. Get in touch for detailed information.';
      } else if (stepIndex === 8) {
        mainTitle = "PLANNING";
        subtitle = 'Things to consider for your project. Multiple options can be selected.';
      } else if (stepIndex === 9) {
        mainTitle = "ESTIMATED COST";
        subtitle = 'Your pool package breakdown and total cost estimate.';
      }
      // === Явно обновляем DOM ===
      document.querySelector('.main-title').textContent = mainTitle;
      document.querySelector('.subtitle').textContent = subtitle;
      if (stepIndex === 0) {
        // Step 1: Material
        grid.style.display = '';
        concreteForm.style.display = 'none';
        grid.innerHTML = materialOptions.map(d => `
          <div class="design-card${selectedMaterial === d.id ? ' selected' : ''}" tabindex="0" data-id="${d.id}">
            <div class="card-content">
            ${d.badge ? `<div class="badge">${d.badge}</div>` : ''}
            <img src="${d.img}" alt="${d.title}" class="design-img" />
            <div class="card-title">${d.title}</div>
            <div class="card-desc">${d.desc}</div>
            </div>
            <!-- LEARN MORE BUTTON (универсально) -->
            <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${d.title.replace(/'/g, "&#39;")}', 'Demo info about ${d.title}. (TODO: Inject real content here)')">Learn More</button>
            <!-- END LEARN MORE BUTTON -->
          </div>
        `).join('');
        document.querySelectorAll('.design-card').forEach(card => {
          card.onclick = () => {
            selectedMaterial = card.dataset.id;
            // Если выбран не concrete, сбрасываем форму
            if (selectedMaterial !== 'concrete') selectedShape = null;
            renderStep();
            updateNextBtn();
          };
          card.onkeydown = e => {
            if (e.key === 'Enter' || e.key === ' ') {
              selectedMaterial = card.dataset.id;
              if (selectedMaterial !== 'concrete') selectedShape = null;
              renderStep();
              updateNextBtn();
            }
          };
        });
        updateNextBtn();
      } else if (stepIndex === 1) {
        // Step 2: Design
        if (selectedMaterial === 'concrete') {
          grid.style.display = 'none';
          concreteForm.style.display = '';
          // --- UI: Concrete pool shapes ---
          let shapeHtml = concreteShapes.map(s => `
            <div class="design-card${selectedShape === s.id ? ' selected' : ''}" tabindex="0" data-id="${s.id}">
              <div class="card-content">
              <img src="${s.img}" alt="${s.title}" class="design-img" />
              <div class="card-title">${s.title}</div>
              <div class="card-desc">${s.desc}</div>
              </div>
              <!-- LEARN MORE BUTTON (универсально) -->
              <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${s.title.replace(/'/g, "&#39;")}', 'Demo info about ${s.title}. (TODO: Inject real content here)')">Learn More</button>
              <!-- END LEARN MORE BUTTON -->
            </div>
          `).join('');
          // --- После выбора формы показываем размеры и визуализацию ---
          let paramsAndVisual = '';
          if (selectedShape) {
            // --- Блок выбора размеров ---
            let paramFields = [
              { key: 'length', label: 'Length', min: 2, max: 50, step: 0.1, value: concreteDims.length },
              { key: 'width', label: 'Width', min: 2, max: 20, step: 0.1, value: concreteDims.width },
              { key: 'depth', label: 'Depth', min: 1, max: 3, step: 0.1, value: concreteDims.depth }
            ];
            let sliders = paramFields.map(p => `
              <div class="concrete-param-row">
                <label class="concrete-label">${p.label}:</label>
                <input type="number" class="concrete-num" id="num-${p.key}" min="${p.min}" max="${p.max}" step="${p.step}" value="${p.value}" autocomplete="off"> м
                <input type="range" class="concrete-slider" id="slider-${p.key}" min="${p.min}" max="${p.max}" step="${p.step}" value="${p.value}">
              </div>
            `).join('');
            // --- WOW SVG визуализация ---
            let visualPreview = `
              <div class="visual-preview-container">
                <div class="svg-label">Top view</div>
                <div id="svg-top-view"></div>
                <div class="svg-label">Side view (depth)</div>
                <div id="svg-side-view"></div>
              </div>
            `;
            let perim = 2 * (Number(concreteDims.length) + Number(concreteDims.width));
            let vol = (Number(concreteDims.length) * Number(concreteDims.width) * Number(concreteDims.depth)).toFixed(2);
            let calcHtml = `<div style="margin:18px 0 0 0;text-align:center;color:#1786f9;font-size:1.1em;">Perimeter: <b>${perim} m</b> &nbsp; | &nbsp; Volume: <b>${vol} m³</b></div>`;
            paramsAndVisual = `
              <div style="min-height:140px;display:flex;flex-direction:column;justify-content:center;max-width:420px;margin:0 auto;">
                <div class="concrete-params-block">
              ${sliders}
                </div>
                ${visualPreview}
              ${calcHtml}
            </div>
          `;
          }
          concreteForm.innerHTML = `
            <div class="design-grid">${shapeHtml}</div>
            ${paramsAndVisual}
          `;
          // --- События выбора формы ---
          document.querySelectorAll('#concreteForm .design-card').forEach(card => {
            card.onclick = () => { selectedShape = card.dataset.id; renderStep(); updateNextBtn(); };
            card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { selectedShape = card.dataset.id; renderStep(); updateNextBtn(); } };
          });
          // --- События для input/range ---
          if (selectedShape) {
            let paramFields = [
              { key: 'length', min: 2, max: 50, step: 0.1 },
              { key: 'width', min: 2, max: 20, step: 0.1 },
              { key: 'depth', min: 1, max: 3, step: 0.1 }
            ];
            paramFields.forEach(p => {
              const num = document.getElementById(`num-${p.key}`);
              const slider = document.getElementById(`slider-${p.key}`);
              slider.oninput = e => {
                let v = parseFloat(e.target.value);
                if (isNaN(v)) v = p.min;
                num.value = v;
                concreteDims[p.key] = v;
                let perim = 2 * (Number(concreteDims.length) + Number(concreteDims.width));
                let vol = (Number(concreteDims.length) * Number(concreteDims.width) * Number(concreteDims.depth)).toFixed(2);
                document.querySelector('.concrete-params-block').nextElementSibling.nextElementSibling.innerHTML = `Perimeter: <b>${perim} m</b> &nbsp; | &nbsp; Volume: <b>${vol} m³</b>`;
                renderConcreteWOWSVGs(selectedShape, concreteDims.length, concreteDims.width, concreteDims.depth);
              };
              num.oninput = e => {
                slider.value = num.value;
                concreteDims[p.key] = parseFloat(num.value) || '';
                let perim = 2 * (Number(concreteDims.length) + Number(concreteDims.width));
                let vol = (Number(concreteDims.length) * Number(concreteDims.width) * Number(concreteDims.depth)).toFixed(2);
                document.querySelector('.concrete-params-block').nextElementSibling.nextElementSibling.innerHTML = `Perimeter: <b>${perim} m</b> &nbsp; | &nbsp; Volume: <b>${vol} m³</b>`;
                renderConcreteWOWSVGs(selectedShape, concreteDims.length, concreteDims.width, concreteDims.depth);
              };
              num.onblur = e => {
                let v = parseFloat(num.value);
                if (isNaN(v)) v = p.min;
                if (v < p.min) v = p.min;
                if (v > p.max) v = p.max;
                num.value = v;
                slider.value = v;
                concreteDims[p.key] = v;
                renderStep();
              };
              num.onkeydown = e => { if (e.key === 'Enter') num.blur(); };
            });
            // --- WOW SVG рендеринг ---
            renderConcreteWOWSVGs(selectedShape, concreteDims.length, concreteDims.width, concreteDims.depth);
          }
          // Всегда обновляем состояние NEXT после рендера блока выбора формы
          updateNextBtn();
        } else {
          grid.style.display = '';
          concreteForm.style.display = 'none';
          let models = selectedMaterial === 'fibreglass' ? fibreglassModels : [
            { id: "vinyl-std", title: "Vinyl Standard", desc: "Standard vinyl pool", img: "images/placeholder.jfif", link: { label: "Learn more", url: "#" }, size: null }
          ];
          grid.innerHTML = models.map(m => `
            <div class="design-card${selectedDesign === m.id ? ' selected' : ''}" tabindex="0" data-id="${m.id}">
              <div class="card-content">
              <img src="${m.img}" alt="${m.title}" class="design-img" />
              <div class="card-title">${m.title}</div>
              <div class="card-desc">${m.desc}</div>
                <div class="pool-size">${
                  m.size
                    ? (Array.isArray(m.size)
                        ? m.size.map(sz => sz || 'Размер уточняется').join('<br>')
                        : m.size)
                    : 'Размер уточняется'
                }</div>
              </div>
              <!-- LEARN MORE BUTTON (универсально) -->
              <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${m.title.replace(/'/g, "&#39;")}', 'Demo info about ${m.title}. (TODO: Inject real content here)')">Learn More</button>
              <!-- END LEARN MORE BUTTON -->
            </div>
          `).join('');
          document.querySelectorAll('.design-card').forEach(card => {
            card.onclick = () => { selectedDesign = card.dataset.id; renderStep(); updateNextBtn(); };
            card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { selectedDesign = card.dataset.id; renderStep(); updateNextBtn(); } };
          });
          updateNextBtn();
        }
      } else if (stepIndex === 2) {
        grid.style.display = '';
        concreteForm.style.display = 'none';
        grid.innerHTML = equipmentOptions.map(opt => `
          <div class="design-card${selectedEquipment === opt.id ? ' selected' : ''}" tabindex="0" data-id="${opt.id}">
            <div class="card-content">
            ${opt.badge ? `<div class="badge">${opt.badge}</div>` : ''}
            <img src="${opt.img}" alt="${opt.title}" class="design-img" />
            <div class="card-title">${opt.title}</div>
            <div class="card-desc">${opt.desc}</div>
            </div>
            <!-- LEARN MORE BUTTON (универсально) -->
            <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
            <!-- END LEARN MORE BUTTON -->
          </div>
        `).join('');
        document.querySelectorAll('.design-card').forEach(card => {
          card.onclick = () => { selectedEquipment = card.dataset.id; renderStep(); updateNextBtn(); };
          card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { selectedEquipment = card.dataset.id; renderStep(); updateNextBtn(); } };
        });
        updateNextBtn();
      } else if (stepIndex === 3) {
        grid.style.display = '';
        concreteForm.style.display = 'none';
        // --- STEP 4: Finishes (Coping + Internal) ---
        grid.innerHTML = `
          <div class="finishes-container">
            <!-- Coping Material GROUP START -->
            <div class="finish-group">
              <div class="finish-title">Coping Material</div>
              <div class="design-grid">
                ${finishesCoping.map(opt => `
                  <div class="finishes-card${selectedCoping === opt.id ? ' selected' : ''}"
                       tabindex="0" role="button" aria-checked="${selectedCoping === opt.id}"
                       data-id="${opt.id}" data-group="coping">
                    <div class="card-content">
                      ${opt.badge ? `<div class="badge">${opt.badge}</div>` : ''}
                      <img src="${opt.img}" alt="${opt.title}" class="finishes-img" />
                      <div class="card-title">${opt.title}</div>
                      <div class="card-desc">${opt.desc}</div>
                    </div>
                    <!-- LEARN MORE BUTTON (универсально) -->
                    <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
                    <!-- END LEARN MORE BUTTON -->
                  </div>
                `).join('')}
              </div>
            </div>
            <!-- Coping Material GROUP END -->
            <!-- Internal Finish GROUP START -->
            <div class="finish-group">
              <div class="finish-title">Internal Finish</div>
              <div class="design-grid">
                ${finishesInternal.map(opt => `
                  <div class="finishes-card${selectedInternal === opt.id ? ' selected' : ''}"
                       tabindex="0" role="button" aria-checked="${selectedInternal === opt.id}"
                       data-id="${opt.id}" data-group="internal">
                    <div class="card-content">
                      ${opt.badge ? `<div class="badge">${opt.badge}</div>` : ''}
                      <img src="${opt.img}" alt="${opt.title}" class="finishes-img" />
                      <div class="card-title">${opt.title}</div>
                      <div class="card-desc">${opt.desc}</div>
                    </div>
                    <!-- LEARN MORE BUTTON (универсально) -->
                    <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
                    <!-- END LEARN MORE BUTTON -->
                  </div>
                `).join('')}
              </div>
            </div>
            <!-- Internal Finish GROUP END -->
          </div>
        `;
        // --- Обработчики выбора для finishes-card ---
        document.querySelectorAll('.finishes-card[data-group="coping"]').forEach(card => {
          card.onclick = () => {
            selectedCoping = card.dataset.id;
            renderStep();
            updateNextBtn();
          };
          card.onkeydown = e => {
            if (e.key === 'Enter' || e.key === ' ') {
              selectedCoping = card.dataset.id;
              renderStep();
              updateNextBtn();
            }
          };
        });
        document.querySelectorAll('.finishes-card[data-group="internal"]').forEach(card => {
          card.onclick = () => {
            selectedInternal = card.dataset.id;
            renderStep();
            updateNextBtn();
          };
          card.onkeydown = e => {
            if (e.key === 'Enter' || e.key === ' ') {
              selectedInternal = card.dataset.id;
              renderStep();
              updateNextBtn();
            }
          };
        });
        updateNextBtn();
      } else if (stepIndex === 4) {
        grid.style.display = '';
        concreteForm.style.display = 'none';
        grid.innerHTML = hardscapeOptions.map(opt => `
          <div class="design-card${selectedHardscape === opt.id ? ' selected' : ''}" tabindex="0" data-id="${opt.id}">
            <div class="card-content">
              <img src="${opt.img}" alt="${opt.title}" class="design-img" />
              <div class="card-title">${opt.title}</div>
              <div class="card-desc">${opt.desc}</div>
            </div>
            <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
          </div>
        `).join('');
        document.querySelectorAll('.design-card').forEach(card => {
          card.onclick = () => { selectedHardscape = card.dataset.id; renderStep(); updateNextBtn(); };
          card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { selectedHardscape = card.dataset.id; renderStep(); updateNextBtn(); } };
        });
        updateNextBtn();
      } else if (stepIndex === 5) {
        grid.style.display = '';
        concreteForm.style.display = 'none';
        grid.innerHTML = coverOptions.map(opt => `
          <div class="design-card${selectedCover === opt.id ? ' selected' : ''}" tabindex="0" data-id="${opt.id}">
            <div class="card-content">
              <img src="${opt.img}" alt="${opt.title}" class="design-img" />
              <div class="card-title">${opt.title}</div>
              <div class="card-desc">${opt.desc}</div>
            </div>
            <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
          </div>
        `).join('');
        document.querySelectorAll('.design-card').forEach(card => {
          card.onclick = () => { selectedCover = card.dataset.id; renderStep(); updateNextBtn(); };
          card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { selectedCover = card.dataset.id; renderStep(); updateNextBtn(); } };
        });
        updateNextBtn();
      } else if (stepIndex === 6) {
        mainTitle = 'SELECT AMENITIES';
        subtitle = 'Choose additional features for your pool. Multiple options can be selected.';
        grid.style.display = '';
        concreteForm.style.display = 'none';
        grid.innerHTML = amenitiesOptions.map(opt => `
          <div class="design-card${selectedAmenities.includes(opt.id) ? ' selected' : ''}" tabindex="0" data-id="${opt.id}">
            <div class="card-content">
              ${opt.badge ? `<div class="badge">${opt.badge}</div>` : ''}
              <img src="${opt.img}" alt="${opt.title}" class="design-img" />
              <div class="card-title">${opt.title}</div>
              <div class="card-desc">${opt.desc}</div>
            </div>
            <!-- LEARN MORE BUTTON (универсально) -->
            <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
            <!-- END LEARN MORE BUTTON -->
          </div>
        `).join('');
        document.querySelectorAll('.design-card').forEach(card => {
          card.onclick = () => {
            if (selectedAmenities.includes(card.dataset.id)) {
              selectedAmenities = selectedAmenities.filter(id => id !== card.dataset.id);
            } else {
              selectedAmenities.push(card.dataset.id);
            }
            renderStep();
            updateNextBtn();
          };
          card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') {
            if (selectedAmenities.includes(card.dataset.id)) {
              selectedAmenities = selectedAmenities.filter(id => id !== card.dataset.id);
            } else {
              selectedAmenities.push(card.dataset.id);
            }
            renderStep();
            updateNextBtn();
          } };
        });
        updateNextBtn();
      } else if (stepIndex === 7) {
        mainTitle = "WHAT'S INCLUDED";
        subtitle = 'All services and materials included in your pool package. Get in touch for detailed information.';
        grid.style.display = '';
        concreteForm.style.display = 'none';
        grid.innerHTML = includedOptions.map(opt => `
          <div class="design-card whats-included" tabindex="0" data-id="${opt.id}">
            <div class="card-content">
              <div class="badge">Included</div>
              <img src="${opt.img}" alt="${opt.title}" class="design-img" />
              <div class="card-title">${opt.title}</div>
              <div class="card-desc">${opt.desc}</div>
            </div>
            <!-- LEARN MORE BUTTON (универсально) -->
            <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
            <!-- END LEARN MORE BUTTON -->
          </div>
        `).join('');
        // Карточки не кликабельны, только для информации
        document.querySelectorAll('.design-card.whats-included').forEach(card => {
          card.style.cursor = 'default';
          card.onclick = null;
          card.onkeydown = null;
        });
        updateNextBtn();
      } else if (stepIndex === 8) {
        mainTitle = "PLANNING";
        subtitle = 'Things to consider for your project. Multiple options can be selected.';
        grid.style.display = '';
        concreteForm.style.display = 'none';
        grid.innerHTML = planningOptions.map(opt => `
          <div class="design-card${selectedPlanning.includes(opt.id) ? ' selected' : ''}" tabindex="0" data-id="${opt.id}">
            <div class="card-content">
              <img src="${opt.img}" alt="${opt.title}" class="design-img" />
              <div class="card-title">${opt.title}</div>
              <div class="card-desc">${opt.desc}</div>
            </div>
            <!-- LEARN MORE BUTTON (универсально) -->
            <button class="learnmore-btn" type="button" tabindex="0" onclick="openLearnMore('${opt.title.replace(/'/g, "&#39;")}', 'Demo info about ${opt.title}. (TODO: Inject real content here)')">Learn More</button>
            <!-- END LEARN MORE BUTTON -->
          </div>
        `).join('');
        document.querySelectorAll('.design-card').forEach(card => {
          card.onclick = () => {
            if (selectedPlanning.includes(card.dataset.id)) {
              selectedPlanning = selectedPlanning.filter(id => id !== card.dataset.id);
            } else {
              selectedPlanning.push(card.dataset.id);
            }
            renderStep();
            updateNextBtn();
          };
          card.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') {
            if (selectedPlanning.includes(card.dataset.id)) {
              selectedPlanning = selectedPlanning.filter(id => id !== card.dataset.id);
            } else {
              selectedPlanning.push(card.dataset.id);
            }
            renderStep();
            updateNextBtn();
          } };
        });
        updateNextBtn();
      } else if (stepIndex === 7) {
        stepIndex = 6; renderStep();
      } else if (stepIndex === 8 && selectedPlanning.length) {
        stepIndex = 9; renderStep();
      } else if (stepIndex === 9) {
        mainTitle = "ESTIMATED COST";
        subtitle = 'Your pool package breakdown and total cost estimate.';
        grid.style.display = '';
        concreteForm.style.display = 'none';
        
        const { total, breakdown } = calculateTotalCost();
        const breakdownKeys = Object.keys(breakdown);
        grid.innerHTML = `
          <div style="max-width: 800px; margin: 0 auto; width: 100%;">
            <div style="background: #f8fafc; border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 2px solid #e8f1fb;">
              <h3 style="margin: 0 0 20px 0; color: #0797ee; font-size: 1.3em; text-align: center;">Cost Breakdown</h3>
              ${breakdownKeys.map(key => {
                const item = breakdown[key];
                const isIncluded = item.included;
                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e8f1fb;">
                  <div>
                    <div style="font-weight: 600; color: #2a3a4a; margin-bottom: 4px;">${item.title}</div>
                    <div style="font-size: 0.9em; color: #6a7a8a;">${item.description}</div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-weight: 700; color: #0797ee; font-size: 1.2em;">$${item.cost.toLocaleString()}</span>
                    ${isIncluded ? '<span style="background:#e8f1fb;color:#0797ee;font-size:12px;padding:2px 8px;border-radius:6px;font-weight:600;">Included</span>' : ''}
                    ${!isIncluded && item.removable ? `<button onclick="window.removeBreakdownOption('${key}','${item.id}')" style="background:none;border:none;color:#e96c2c;font-size:1.2em;cursor:pointer;" title="Remove">&#10006;</button>` : ''}
                  </div>
                </div>`;
              }).join('')}
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-top: 2px solid #0797ee; margin-top: 12px;">
                <div style="font-weight: 700; color: #2a3a4a; font-size: 1.3em;">Total Estimated Cost</div>
                <div style="font-weight: 700; color: #0797ee; font-size: 1.5em;">$${total.toLocaleString()}</div>
              </div>
            </div>
            <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
              <button onclick="getConsultation()" style="background: #0797ee; color: white; border: none; padding: 16px 32px; border-radius: 12px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 16px #0797ee33;" onmouseover="this.style.background='#1786f9'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#0797ee'; this.style.transform='translateY(0)'">Get Consultation</button>
              <button onclick="addToCart()" style="background: #e96c2c; color: white; border: none; padding: 16px 32px; border-radius: 12px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 16px #e96c2c33;" onmouseover="this.style.background='#ff7f3f'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#e96c2c'; this.style.transform='translateY(0)'">Add to Cart</button>
            </div>
          </div>
        `;
        
        updateNextBtn();
      }
    }
    renderStep();

    // === 1. КОНФИГ: ВСЕ ЦЕНЫ И КОЭФФИЦИЕНТЫ ===
    // TODO: заменить на реальные значения при интеграции
    const priceConfig = {
      FIBREGLASS_BASE: 25000, // Фиксированная цена для fibreglass
      CONCRETE_BASE: 29000,   // Фиксированная цена для concrete
      TILE_PRICE_PER_M2: 80,  // Плитка за м²
      COPING_PRICE_PER_M: 50, // Парапет за м
      EXCAVATION_PRICE_PER_M3: 40, // Земляные работы за м³
      CONCRETE_PRICE_PER_M2: 100,  // Бетонирование за м²
      ELECTRICAL: 2500,       // Электрика/коммуникации (всегда включено)
      LANDSCAPING: 5000,      // Ландшафтный дизайн (пример)
      // Оборудование
      equipment: {
        basic: 8000,
        intermediate: 12000,
        family: 15000
      },
      CONCRETE_SHELL_PER_M3: 3500 // новая строка
    };

    // === 2. ОПЦИИ/КАРТОЧКИ: ВСЕГДА С ПОЛЕМ price и included ===
    // Amenities, hardscape, cover, etc. — все с price и included
    // TODO: заменить на реальные значения/структуру при интеграции
    const amenitiesOptions = [
      { id: "bubblers", title: "Bubblers", desc: "Bubble jets for water features.", img: "images/placeholder.jfif", price: 1200, included: false },
      { id: "fire_pits", title: "Fire Pits", desc: "Outdoor fire features.", img: "images/placeholder.jfif", price: 3500, included: false },
      { id: "lounge_area", title: "Lounge Area", desc: "Comfortable seating area.", img: "images/placeholder.jfif", price: 2800, included: false },
      { id: "deck_jets", title: "Deck Jets", desc: "Water jets on deck surface.", img: "images/placeholder.jfif", price: 1800, included: false },
      { id: "scuppers", title: "Scuppers", desc: "Water overflow features.", img: "images/placeholder.jfif", price: 2200, included: false },
      { id: "in_floor_system", title: "In-Floor System", desc: "Hidden cleaning system.", img: "images/placeholder.jfif", price: 4500, included: false },
      { id: "ozone_sanitation", title: "Ozone Sanitation", desc: "Advanced water treatment.", img: "images/placeholder.jfif", price: 3200, included: false },
      { id: "led_waterbowls", title: "LED Waterbowls", desc: "Illuminated water features.", img: "images/placeholder.jfif", price: 1600, included: false },
      { id: "equipment_automation", title: "Equipment Automation Controls", desc: "Smart pool control system.", img: "images/placeholder.jfif", price: 2800, included: false }
    ];
    const hardscapeOptions = [
      { id: "honed_concrete", title: "Honed Concrete", desc: "Smooth, modern concrete finish.", img: "images/placeholder.jfif", price: 3500, included: false },
      { id: "natural_stone", title: "Natural Stone", desc: "Premium natural stone paving.", img: "images/placeholder.jfif", price: 8500, included: false },
      { id: "pavers", title: "Pavers", desc: "Classic paver hardscape.", img: "images/placeholder.jfif", price: 4200, included: false },
      { id: "timber_decking", title: "Timber Decking", desc: "Warm timber deck area.", img: "images/placeholder.jfif", price: 3800, included: false }
    ];
    const coverOptions = [
      { id: "solar_bubble", title: "Solar Bubble Cover", desc: "Energy-efficient solar cover.", img: "images/placeholder.jfif", price: 800, included: false },
      { id: "automatic", title: "Automatic Pool Cover", desc: "Convenient automatic cover.", img: "images/placeholder.jfif", price: 12000, included: false }
    ];
    // ... остальные опции по аналогии ...

    // === 3. ФУНКЦИИ РАСЧЁТА ДЛЯ КАЖДОЙ СТАТЬИ ===
    // Плитка по площади
    function calcTileCost(length, width) {
      return length * width * priceConfig.TILE_PRICE_PER_M2;
    }
    // Парапет по периметру
    function calcCopingCost(length, width) {
      return 2 * (length + width) * priceConfig.COPING_PRICE_PER_M;
    }
    // Земляные работы по объёму
    function calcExcavationCost(length, width, depth) {
      return length * width * depth * priceConfig.EXCAVATION_PRICE_PER_M3;
    }
    // Бетонирование по площади дна
    function calcConcreteCost(length, width) {
      return length * width * priceConfig.CONCRETE_PRICE_PER_M2;
    }
    // Оборудование
    function calcEquipmentCost(selectedEquipment) {
      const opt = equipmentOptions.find(o => o.id === selectedEquipment);
      return calcOptionCost(opt);
    }
    // Ландшафтный дизайн (если выбран)
    function calcLandscapingCost(selectedLandscaping) {
      // Можно расширить для разных вариантов
      return selectedLandscaping ? priceConfig.LANDSCAPING : 0;
    }
    // Доп.опции (amenities, hardscape, cover, ...)
    function calcExtrasCost(selectedExtras, optionsList) {
      if (!selectedExtras || !selectedExtras.length) return 0;
      return selectedExtras.reduce((sum, id) => {
        const opt = optionsList.find(o => o.id === id);
        return sum + calcOptionCost(opt);
      }, 0);
    }
    // Если опция included, цена всегда 0
    function calcOptionCost(option) {
      return option && option.included ? 0 : (option.price || 0);
    }

    // Функция для удаления опции из breakdown (глобально)
    function removeBreakdownOption(key, id) {
      // Amenities
      if (key.startsWith('amenity_') || key === 'amenities') {
        selectedAmenities = selectedAmenities.filter(aid => aid !== id);
      }
      // Equipment
      else if (key === 'equipment') {
        selectedEquipment = null;
      }
      // Cover
      else if (key === 'cover') {
        selectedCover = null;
      }
      // Hardscape
      else if (key === 'hardscape') {
        selectedHardscape = null;
      }
      // Finishes Coping
      else if (key === 'finishesCoping') {
        selectedCoping = null;
      }
      // Finishes Internal
      else if (key === 'finishesInternal') {
        selectedInternal = null;
      }
      // Included options (нельзя удалять, но на всякий случай)
      else if (key.startsWith('included_')) {
        // ничего не делаем
      }
      renderStep();
    }
    // Делаем функцию глобальной для вызова из HTML:
    window.removeBreakdownOption = removeBreakdownOption;

    // === КНОПКА "New Calculation" ===
    function resetCalculator() {
      stepIndex = 0;
      selectedMaterial = null;
      selectedDesign = null;
      selectedShape = null;
      concreteDims = { length: 8, width: 4, depth: 1.5 };
      selectedEquipment = null;
      selectedCoping = null;
      selectedInternal = null;
      selectedHardscape = null;
      selectedCover = null;
      selectedAmenities = [];
      selectedPlanning = [];
      renderStep();
    }
    window.resetCalculator = resetCalculator;

    // ... существующий код ...
    // === В рендере breakdown ===
    // Найти место, где stepIndex === 9 (ESTIMATED COST) и заменить prevBtn на New Calculation
    // ...
    if (stepIndex === 9) {
      document.getElementById('prevBtn').style.display = '';
      document.getElementById('prevBtn').textContent = 'New Calculation';
      document.getElementById('prevBtn').onclick = resetCalculator;
    } else {
      document.getElementById('prevBtn').textContent = 'BACK';
      document.getElementById('prevBtn').onclick = function() {
        if (stepIndex === 1.5) { stepIndex = 1; renderStep(); }
        else if (stepIndex === 1) {
          if (selectedMaterial === 'concrete') selectedShape = null;
          stepIndex = 0; renderStep();
        }
        else if (stepIndex === 2) { stepIndex = 1; renderStep(); }
        else if (stepIndex === 3) { stepIndex = 2; renderStep(); }
        else if (stepIndex === 4) { stepIndex = 3; renderStep(); }
        else if (stepIndex === 5) { stepIndex = 4; renderStep(); }
        else if (stepIndex === 6) { stepIndex = 5; renderStep(); }
        else if (stepIndex === 7) { stepIndex = 6; renderStep(); }
        else if (stepIndex === 8) { stepIndex = 7; renderStep(); }
      };
    }
    // ...
  </script>
</body>
</html>
